<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IEP Recrutamento — Online</title>
  <style>
    :root{
      --bg:#0b0f19;
      --card:#10182a;
      --muted:#9aa4b2;
      --text:#e7eefc;
      --border:rgba(255,255,255,.10);
      --accent:#5aa7ff;
      --good:#36d399;
      --bad:#fb7185;
      --warn:#fbbf24;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;}
    body{margin:0;background:linear-gradient(180deg,#070a12 0%,#0b0f19 100%);color:var(--text);}
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:22px;}
    .topbar{display:flex;gap:14px;align-items:center;justify-content:space-between;margin-bottom:18px;}
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand h1{margin:0;font-size:20px;letter-spacing:.2px}
    .brand small{color:var(--muted)}
    .statusrow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,.03);color:var(--muted);font-size:12px}
    .pill strong{color:var(--text)}
    .btn{appearance:none;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn:hover{border-color:rgba(255,255,255,.18);background:rgba(255,255,255,.06)}
    .btn.primary{border-color:rgba(90,167,255,.55);background:rgba(90,167,255,.12)}
    .btn.primary:hover{background:rgba(90,167,255,.18)}
    .btn.danger{border-color:rgba(251,113,133,.55);background:rgba(251,113,133,.10)}
    .btn.danger:hover{background:rgba(251,113,133,.14)}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    @media(max-width:920px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.03) 0%,rgba(255,255,255,.02) 100%);border:1px solid var(--border);border-radius:18px;padding:16px}
    .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    .tab{padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:rgba(255,255,255,.03);cursor:pointer;font-weight:700}
    .tab.active{border-color:rgba(90,167,255,.55);background:rgba(90,167,255,.10)}
    .muted{color:var(--muted)}
    .h2{margin:0 0 8px;font-size:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:rgba(0,0,0,.18);color:var(--text);outline:none}
    .input:focus{border-color:rgba(90,167,255,.6)}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:560px){.two{grid-template-columns:1fr}}
    .loginBox{display:grid;gap:10px}
    .help{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:var(--border);margin:12px 0}
    .toast{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:22px;z-index:9999;
      min-width:320px;max-width:min(920px,calc(100vw - 30px));
      display:none;gap:10px;align-items:flex-start;
      background:rgba(16,24,42,.92);border:1px solid var(--border);
      padding:12px 14px;border-radius:16px;backdrop-filter:blur(12px);
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .toast.show{display:flex}
    .dot{width:10px;height:10px;border-radius:50%;margin-top:4px}
    .dot.good{background:var(--good)}
    .dot.bad{background:var(--bad)}
    .dot.warn{background:var(--warn)}
    .toast b{display:block;margin-bottom:2px}
    .calendarHead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .calGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .dow{font-size:12px;color:var(--muted);text-align:center;padding:6px 0}
    .day{
      border:1px solid var(--border);border-radius:14px;
      background:rgba(255,255,255,.02);padding:10px 10px;
      min-height:64px;cursor:pointer;position:relative;
      display:flex;flex-direction:column;gap:6px;
    }
    .day:hover{border-color:rgba(255,255,255,.18)}
    .day.disabled{opacity:.35;cursor:default}
    .day.selected{border-color:rgba(90,167,255,.7);background:rgba(90,167,255,.10)}
    .num{font-weight:800}
    .badges{display:flex;gap:6px;flex-wrap:wrap}
    .badge{
      font-size:11px;padding:3px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);color:var(--muted);
    }
    .badge.has{border-color:rgba(54,211,153,.35);background:rgba(54,211,153,.10);color:#bff7df}
    .formRow{display:grid;gap:10px;margin-top:10px}
    .rightStack{display:grid;gap:12px}
    .smallTitle{font-size:13px;font-weight:800;margin:0 0 6px}
    .note{font-size:12px;color:var(--muted);line-height:1.45}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>IEP Recrutamento — Online</h1>
        <small class="muted">Firestore + Auth (Email/Senha) • Admin/Assistente • Realtime</small>
      </div>

      <div class="statusrow">
        <div class="pill" id="authPill">Status: <strong id="authStatus">Carregando...</strong></div>
        <button class="btn danger" id="logoutBtn" style="display:none">Sair</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="tabs">
          <button class="tab active" id="tabRecruit">Recrutamento</button>
          <button class="tab" id="tabScreen">Screening — Calendário</button>
        </div>

        <section id="recruitSection">
          <h2 class="h2">Recrutamento</h2>
          <p class="muted" style="margin:0 0 10px">Aqui você mantém sua tela atual (cadastro, indicadores, etc.).</p>
          <div class="divider"></div>
          <p class="muted" style="margin:0">
            (Área reservada para seu conteúdo atual. O login/Firestore continuam funcionando neste mesmo arquivo.)
          </p>
        </section>

        <section id="screenSection" style="display:none">
          <h2 class="h2">Screening — Calendário</h2>

          <div class="calendarHead">
            <button class="btn" id="prevMonth">◀ Mês</button>
            <div class="pill"><strong id="monthLabel">—</strong></div>
            <button class="btn" id="nextMonth">Mês ▶</button>
          </div>

          <div class="calGrid" id="dowRow"></div>
          <div class="calGrid" id="cal"></div>

          <p class="help" style="margin:10px 0 0">
            Clique em um dia para selecionar e depois salve o procedimento. <span class="muted">(Funciona somente logado)</span>
          </p>

          <div class="divider"></div>

          <h3 class="h2" style="margin-top:0">Novo procedimento</h3>
          <div class="row">
            <div class="pill">Dia selecionado: <strong id="selectedDayLabel">—</strong></div>
          </div>

          <div class="formRow">
            <label class="smallTitle" for="procType" style="margin:0">Tipo</label>
            <select class="input" id="procType">
              <option value="TCLE agendado">TCLE agendado</option>
              <option value="TCLE assinado">TCLE assinado</option>
              <option value="Exames laboratoriais">Exames laboratoriais</option>
              <option value="Exames de imagem">Exames de imagem</option>
              <option value="Consulta / Avaliação">Consulta / Avaliação</option>
              <option value="Falha de screening">Falha de screening</option>
              <option value="Randomizado">Randomizado</option>
              <option value="Outro">Outro</option>
            </select>

            <button class="btn primary" id="saveProcBtn">Salvar procedimento</button>
          </div>

          <p class="note" style="margin:10px 0 0">
            Se algo bloquear o salvamento, vai aparecer um erro detalhado no toast e no Console.
          </p>
        </section>
      </div>

      <div class="rightStack">
        <div class="card">
          <h2 class="h2">Login</h2>
          <div class="loginBox">
            <input class="input" id="email" type="email" autocomplete="username" placeholder="Email" />
            <input class="input" id="password" type="password" autocomplete="current-password" placeholder="Senha" />
            <button class="btn primary" id="loginBtn">Entrar</button>
            <button class="btn" id="resetBtn">Esqueci minha senha</button>
            <div class="help">
              Dica: se der “muitas tentativas”, use “Esqueci minha senha” para destravar.
            </div>
          </div>
        </div>

        <div class="card">
          <p class="smallTitle">Debug</p>
          <div class="note">
            <div>Projeto: <span class="mono" id="dbgProject">—</span></div>
            <div>AuthDomain: <span class="mono" id="dbgAuthDomain">—</span></div>
            <div>Usuário: <span class="mono" id="dbgUser">—</span></div>
            <div>Role: <span class="mono" id="dbgRole">—</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="dot" id="toastDot"></div>
    <div>
      <b id="toastTitle">—</b>
      <div id="toastMsg" class="note" style="margin:0"></div>
    </div>
  </div>

  <script type="module">
  // Firebase config (copiado do Firebase Console)

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    sendPasswordResetEmail,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    addDoc,
    collection,
    query,
    where,
    onSnapshot,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCvoVAWsVMYfAQv-pISsn7mNfdInIjLDFo",
    authDomain: "iep-recrutamento.firebaseapp.com",
    projectId: "iep-recrutamento",
    storageBucket: "iep-recrutamento.firebasestorage.app",
    messagingSenderId: "297731374831",
    appId: "1:297731374831:web:684eed6683602d6c3fe51a",
    measurementId: "G-8ST5S7FWE0"
  };

  // Proteção contra erro de config
  if (!firebaseConfig.apiKey) {
    console.error("Firebase apiKey ausente no firebaseConfig.");
  }

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

    // UI refs
    const $ = (id) => document.getElementById(id);

    const tabRecruit = $("tabRecruit");
    const tabScreen  = $("tabScreen");
    const recruitSection = $("recruitSection");
    const screenSection  = $("screenSection");

    const authStatus = $("authStatus");
    const logoutBtn  = $("logoutBtn");

    const emailEl = $("email");
    const passEl  = $("password");
    const loginBtn = $("loginBtn");
    const resetBtn = $("resetBtn");

    const dbgProject = $("dbgProject");
    const dbgAuthDomain = $("dbgAuthDomain");
    const dbgUser = $("dbgUser");
    const dbgRole = $("dbgRole");

    const toast = $("toast");
    const toastDot = $("toastDot");
    const toastTitle = $("toastTitle");
    const toastMsg = $("toastMsg");

    const monthLabel = $("monthLabel");
    const prevMonth = $("prevMonth");
    const nextMonth = $("nextMonth");
    const cal = $("cal");
    const dowRow = $("dowRow");

    const selectedDayLabel = $("selectedDayLabel");
    const procType = $("procType");
    const saveProcBtn = $("saveProcBtn");

    // Toast
    function showToast(kind, title, msg) {
      toastDot.className = "dot " + (kind || "warn");
      toastTitle.textContent = title || "Aviso";
      toastMsg.textContent = msg || "";
      toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.classList.remove("show"), 5200);
    }

    function normalizeError(e) {
      const raw = (e && (e.code || e.message || String(e))) || "Erro desconhecido";
      return raw;
    }

    // Tabs
    function setTab(which) {
      const isRecruit = which === "recruit";
      tabRecruit.classList.toggle("active", isRecruit);
      tabScreen.classList.toggle("active", !isRecruit);
      recruitSection.style.display = isRecruit ? "" : "none";
      screenSection.style.display  = isRecruit ? "none" : "";
    }
    tabRecruit.addEventListener("click", () => setTab("recruit"));
    tabScreen.addEventListener("click", () => setTab("screen"));

    // Debug
    dbgProject.textContent = firebaseConfig.projectId || "—";
    dbgAuthDomain.textContent = firebaseConfig.authDomain || "—";

    // Auth handlers
    loginBtn.addEventListener("click", async () => {
      try {
        const email = (emailEl.value || "").trim();
        const password = passEl.value || "";
        if (!email || !password) {
          showToast("warn","Preencha os campos","Informe email e senha para entrar.");
          return;
        }
        await signInWithEmailAndPassword(auth, email, password);
        showToast("good","Login OK","Você está autenticado.");
      } catch (e) {
        console.error(e);
        showToast("bad","Erro no login", normalizeError(e));
      }
    });

    resetBtn.addEventListener("click", async () => {
      try {
        const email = (emailEl.value || "").trim();
        if (!email) {
          showToast("warn","Informe o email","Digite seu email para enviar o reset.");
          return;
        }
        await sendPasswordResetEmail(auth, email);
        showToast("good","Email enviado","Verifique sua caixa de entrada/spam.");
      } catch (e) {
        console.error(e);
        showToast("bad","Erro no reset", normalizeError(e));
      }
    });

    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
        showToast("good","Saiu","Sessão encerrada.");
      } catch (e) {
        console.error(e);
        showToast("bad","Erro ao sair", normalizeError(e));
      }
    });

    let currentUser = null;
    let currentRole = "—";

    async function ensureUserDoc(uid, email) {
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        // default role: assistente
        await setDoc(ref, { email: email || "", role: "assistente", createdAt: serverTimestamp() });
      }
      const fresh = await getDoc(ref);
      return fresh.data() || {};
    }

    // Calendar state
    const DOW = ["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];
    let viewYear, viewMonth; // month 0-11
    let selectedDate = null; // Date
    let unsubMonth = null;
    let monthData = new Map(); // key yyyy-mm-dd => { count }

    function pad2(n){return String(n).padStart(2,"0");}
    function fmtYMD(d){return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;}

    function setSelectedDate(d) {
      selectedDate = d;
      selectedDayLabel.textContent = d ? fmtYMD(d) : "—";
      renderCalendar();
    }

    function monthStartEnd(y, m) {
      const start = new Date(y, m, 1);
      const end = new Date(y, m+1, 1);
      return { start, end };
    }

    function renderDOW() {
      dowRow.innerHTML = "";
      for (const name of DOW) {
        const el = document.createElement("div");
        el.className = "dow";
        el.textContent = name;
        dowRow.appendChild(el);
      }
    }

    function renderCalendar() {
      if (viewYear == null || viewMonth == null) return;

      const monthName = new Date(viewYear, viewMonth, 1).toLocaleDateString("pt-BR", { month:"long", year:"numeric" });
      monthLabel.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);

      cal.innerHTML = "";

      const first = new Date(viewYear, viewMonth, 1);
      const startDow = first.getDay(); // 0=Dom
      const daysInMonth = new Date(viewYear, viewMonth+1, 0).getDate();

      // leading blanks
      for (let i=0;i<startDow;i++){
        const blank = document.createElement("div");
        blank.className = "day disabled";
        blank.style.visibility = "hidden";
        cal.appendChild(blank);
      }

      for (let day=1; day<=daysInMonth; day++){
        const d = new Date(viewYear, viewMonth, day);
        const key = fmtYMD(d);

        const cell = document.createElement("div");
        cell.className = "day";

        if (selectedDate && fmtYMD(selectedDate) === key) cell.classList.add("selected");

        const num = document.createElement("div");
        num.className = "num";
        num.textContent = day;

        const badges = document.createElement("div");
        badges.className = "badges";

        const info = monthData.get(key);
        if (info && info.count > 0) {
          const b = document.createElement("span");
          b.className = "badge has";
          b.textContent = `${info.count} registro(s)`;
          badges.appendChild(b);
        } else {
          const b = document.createElement("span");
          b.className = "badge";
          b.textContent = "—";
          badges.appendChild(b);
        }

        cell.appendChild(num);
        cell.appendChild(badges);

        cell.addEventListener("click", () => {
          setSelectedDate(d);
        });

        cal.appendChild(cell);
      }
    }

    function setMonth(y, m) {
      viewYear = y; viewMonth = m;
      setSelectedDate(null);
      subscribeMonth();
      renderCalendar();
    }

    function subscribeMonth() {
      if (unsubMonth) { unsubMonth(); unsubMonth = null; }
      monthData = new Map();

      // Só faz realtime se estiver logado
      if (!currentUser) { renderCalendar(); return; }

      const { start, end } = monthStartEnd(viewYear, viewMonth);
      // Usamos string yyyy-mm-dd para filtrar de forma simples (evita timezone)
      const startKey = fmtYMD(start);
      const endKey = fmtYMD(new Date(end.getFullYear(), end.getMonth(), end.getDate())); // 1º dia do próximo mês

      const q = query(
        collection(db, "screening_procedures"),
        where("dateKey", ">=", startKey),
        where("dateKey", "<", endKey)
      );

      unsubMonth = onSnapshot(q, (snap) => {
        monthData = new Map();
        snap.forEach(docSnap => {
          const data = docSnap.data();
          const k = data.dateKey;
          if (!k) return;
          const prev = monthData.get(k) || { count: 0 };
          prev.count += 1;
          monthData.set(k, prev);
        });
        renderCalendar();
      }, (err) => {
        console.error(err);
        showToast("bad","Erro no realtime", normalizeError(err));
      });
    }

    prevMonth.addEventListener("click", () => {
      const d = new Date(viewYear, viewMonth - 1, 1);
      setMonth(d.getFullYear(), d.getMonth());
    });
    nextMonth.addEventListener("click", () => {
      const d = new Date(viewYear, viewMonth + 1, 1);
      setMonth(d.getFullYear(), d.getMonth());
    });

    saveProcBtn.addEventListener("click", async () => {
      try {
        if (!currentUser) {
          showToast("warn","Não autenticado","Faça login para salvar.");
          return;
        }
        if (!selectedDate) {
          showToast("warn","Selecione um dia","Clique em um dia do calendário.");
          return;
        }

        const payload = {
          uid: currentUser.uid,
          email: currentUser.email || "",
          role: currentRole || "assistente",
          type: procType.value,
          dateKey: fmtYMD(selectedDate),
          createdAt: serverTimestamp()
        };

        await addDoc(collection(db, "screening_procedures"), payload);
        showToast("good","Salvo","Procedimento registrado com sucesso.");
      } catch (e) {
        console.error(e);
        showToast("bad","Erro ao salvar", normalizeError(e));
      }
    });

    // Init UI
    renderDOW();
    const now = new Date();
    setMonth(now.getFullYear(), now.getMonth());

    // Auth state
    onAuthStateChanged(auth, async (user) => {
      currentUser = user || null;

      if (!user) {
        authStatus.textContent = "Não autenticado";
        logoutBtn.style.display = "none";
        dbgUser.textContent = "—";
        dbgRole.textContent = "—";
        currentRole = "—";
        if (unsubMonth) { unsubMonth(); unsubMonth = null; }
        monthData = new Map();
        renderCalendar();
        return;
      }

      authStatus.textContent = "Autenticado";
      logoutBtn.style.display = "";
      dbgUser.textContent = user.email || user.uid;

      try {
        const udata = await ensureUserDoc(user.uid, user.email || "");
        currentRole = udata.role || "assistente";
        dbgRole.textContent = currentRole;
      } catch (e) {
        console.error(e);
        currentRole = "assistente";
        dbgRole.textContent = currentRole;
      }

      subscribeMonth();
      renderCalendar();
    });
  </script>
</body>
</html>



<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IEP Recrutamento ‚Äî Online</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg:#0b0c10;
      --panel:#11131a;
      --panel2:#0f1117;
      --line:#24283a;
      --text:#e7e8ee;
      --muted:#a9adbd;
      --blue:#1E90FF;
      --green:#36d399;
      --yellow:#fbbf24;
      --red:#ef4444;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(30,144,255,.16), transparent 55%),
                  radial-gradient(900px 700px at 90% 20%, rgba(54,211,153,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:var(--blue)}
    .wrap{max-width:1200px;margin:26px auto;padding:0 14px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 16px;border:1px solid var(--line);border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      backdrop-filter: blur(8px);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:44px;height:44px;border-radius:12px;background:rgba(30,144,255,.12);
      display:grid;place-items:center;border:1px solid rgba(30,144,255,.25);
    }
    .brand h1{font-size:16px;margin:0}
    .brand small{display:block;color:var(--muted);margin-top:2px;font-size:12px}

    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input,select,button,textarea{
      font:inherit;
      background:var(--panel2);
      color:var(--text);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
    }
    input::placeholder{color:#747a92}
    button{cursor:pointer}
    .btn{background:rgba(30,144,255,.15);border-color:rgba(30,144,255,.35)}
    .btn:hover{background:rgba(30,144,255,.22)}
    .ghost{background:transparent}
    .danger{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35)}
    .danger:hover{background:rgba(239,68,68,.18)}
    .ok{background:rgba(54,211,153,.10);border-color:rgba(54,211,153,.35)}
    .ok:hover{background:rgba(54,211,153,.16)}
    .chip{
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);color:var(--muted);font-size:12px
    }

    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;margin-top:14px;
      border:1px solid var(--line);border-radius:14px;padding:8px;background:rgba(255,255,255,.02);
      align-items:center;
    }
    .tab{
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);color:var(--muted);
    }
    .tab.active{
      background:rgba(30,144,255,.16);
      border-color:rgba(30,144,255,.35);
      color:var(--text);
    }

    .grid{display:grid;grid-template-columns: 1.05fr .95fr;gap:14px;margin-top:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--line);border-radius:var(--radius);background:rgba(255,255,255,.03);
      padding:14px;
    }
    .card h2{margin:0 0 10px 0;font-size:14px;color:#d7dbef}
    .muted{color:var(--muted)}

    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width: 720px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    .kpi{
      border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.18);
      padding:12px 12px;
    }
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .val{font-size:22px;font-weight:600;margin-top:2px}
    .kpi .hint{font-size:12px;margin-top:4px;color:var(--muted)}
    .kpi.blue .val{color:var(--blue)}
    .kpi.green .val{color:var(--green)}
    .kpi.yellow .val{color:var(--yellow)}
    .kpi.red .val{color:var(--red)}

    .formgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 720px){ .formgrid{grid-template-columns:1fr} }
    .formgrid .full{grid-column:1 / -1}
    .field label{display:block;font-size:12px;color:var(--muted);margin:2px 0 6px}
    .field input,.field select,.field textarea{width:100%}
    textarea{min-height:70px;resize:vertical}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}

    .tablewrap{overflow:auto;border:1px solid var(--line);border-radius:14px}
    table{width:100%;border-collapse:collapse;min-width:980px}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:top}
    th{position:sticky;top:0;background:#10131b;font-size:12px;color:var(--muted);text-align:left}
    td{font-size:13px}
    .nowrap{white-space:nowrap}
    .tag{
      font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);
      display:inline-block;background:rgba(255,255,255,.03);color:var(--muted)
    }
    .tag.ok{color:var(--green);border-color:rgba(54,211,153,.35)}
    .tag.no{color:var(--red);border-color:rgba(239,68,68,.35)}
    .small{font-size:12px;color:var(--muted)}
    .hidden{display:none !important}
    .toast{
      position:fixed;right:14px;bottom:14px;
      background:#11131a;border:1px solid var(--line);border-radius:14px;
      padding:10px 12px;min-width:260px;max-width:420px;
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      z-index:9999;
    }
    .toast.err{border-color:rgba(239,68,68,.35)}
    .sep{height:1px;background:rgba(255,255,255,.06);margin:10px 0}

    /* Calendar */
    .calHeader{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .calGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px;}
    .calDow{
      text-align:center;font-size:12px;color:var(--muted);
      padding:6px 0;border:1px solid rgba(255,255,255,.06);border-radius:10px;background:rgba(0,0,0,.14);
    }
    .calDay{
      min-height:86px;border:1px solid rgba(255,255,255,.06);border-radius:14px;
      background:rgba(0,0,0,.16);padding:8px;cursor:pointer;position:relative;
    }
    .calDay:hover{border-color:rgba(30,144,255,.25)}
    .calDay .n{font-size:12px;color:#cfd3ea}
    .calDay .pill{
      margin-top:6px;font-size:11px;color:var(--muted);
      border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);
      border-radius:999px;padding:3px 8px;display:inline-block;max-width:100%;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .calDay.today{outline:2px solid rgba(54,211,153,.35)}
    .calDay.has{border-color:rgba(251,191,36,.22)}
    .calSide{display:grid;grid-template-columns:1.1fr .9fr;gap:14px;margin-top:14px}
    @media(max-width:980px){ .calSide{grid-template-columns:1fr} }
    .noteBox{border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:10px;background:rgba(0,0,0,.18)}
    .listMini{display:flex;flex-direction:column;gap:8px}
    .mini{border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.02);border-radius:14px;padding:10px;}
    .mini b{font-size:12px}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">üß¨</div>
        <div>
          <h1>IEP Recrutamento ‚Äî Online</h1>
          <small>Firestore + Auth (Email/Senha) ‚Ä¢ Admin/Assistente ‚Ä¢ Realtime</small>
        </div>
      </div>

      <div class="row">
        <span id="roleChip" class="chip">N√£o autenticado</span>
        <input id="emailLogin" type="email" placeholder="email" autocomplete="username" style="width:220px">
        <input id="passwordLogin" type="password" placeholder="senha" autocomplete="current-password" style="width:180px">
        <button id="loginBtn" class="btn">Entrar</button>
        <button id="logoutBtn" class="ghost hidden">Sair</button>
      </div>
    </header>

    <div class="tabs">
      <button id="tabRecruit" class="tab active">Recrutamento</button>
      <button id="tabScreen" class="tab">Screening</button>
      <span class="chip" id="notiChip">Notifica√ß√µes: internas</span>
      <button id="enableNotiBtn" class="ghost">Ativar notifica√ß√£o do navegador</button>
    </div>

    <!-- RECRUTAMENTO -->
    <div id="viewRecruit">
      <div class="grid">
        <!-- LEFT -->
        <div class="card">
          <h2>Cadastro / Edi√ß√£o</h2>

          <div class="formgrid">
            <div class="field full">
              <label>Nome / Identificador</label>
              <input id="nome" placeholder="Ex: Iniciais + c√≥digo / nome" />
            </div>

            <div class="field">
              <label>Status</label>
              <select id="status">
                <option value="">Selecione</option>
                <option>Em avalia√ß√£o</option>
                <option>Pr√©-screening</option>
                <option>Screening</option>
                <option>Randomizado</option>
                <option>Falha de screening</option>
              </select>
            </div>

            <div class="field">
              <label>Estudo</label>
              <input id="estudo" placeholder="Ex: EVOKE-04 / SYMPHONY-1" />
            </div>

            <div class="field">
              <label>Data (refer√™ncia)</label>
              <input id="data" type="date" />
            </div>

            <div class="field">
              <label>Encaminhador</label>
              <select id="encaminhador">
                <option value="">Selecione</option>
                <option>Dr. Milton</option>
                <option>Dr. H√©lio</option>
                <option>Dr. Thiago</option>
                <option>ALTY</option>
                <option>Outro</option>
              </select>
            </div>

            <div class="field full hidden" id="wrapOutroEnc">
              <label>Outro encaminhador</label>
              <input id="outroEncaminhador" placeholder="Digite o encaminhador" />
            </div>

            <div class="field">
              <label>TCLE agendado?</label>
              <select id="tcleAgendado">
                <option>N√£o</option>
                <option>Sim</option>
              </select>
            </div>

            <div class="field">
              <label>TCLE assinado?</label>
              <select id="tcleAssinado">
                <option>N√£o</option>
                <option>Sim</option>
              </select>
            </div>

            <div class="field">
              <label>Eleg√≠vel?</label>
              <select id="elegivel">
                <option>Sim</option>
                <option>N√£o</option>
              </select>
            </div>

            <div class="field">
              <label>Motivo n√£o eleg√≠vel</label>
              <select id="motivoNaoElegivel">
                <option value="">(se aplic√°vel)</option>
                <option>Progress√£o</option>
                <option>Perda de follow-up</option>
                <option>Recusa do paciente</option>
                <option>Outro</option>
              </select>
            </div>

            <div class="field full hidden" id="wrapOutroMotivo">
              <label>Outro motivo</label>
              <input id="outroMotivo" placeholder="Digite o motivo" />
            </div>

            <div class="field full">
              <label>Observa√ß√µes</label>
              <textarea id="obs" placeholder="Notas r√°pidas (sem dados sens√≠veis desnecess√°rios)"></textarea>
            </div>
          </div>

          <div class="actions">
            <button id="saveBtn" class="ok">Salvar</button>
            <button id="cancelBtn" class="ghost hidden">Cancelar edi√ß√£o</button>
            <span class="small" id="accessHint">Fa√ßa login para salvar.</span>
          </div>

          <div class="sep"></div>

          <div id="adminPanel" class="hidden">
            <h2>Painel Admin</h2>
            <div class="small muted">Cria√ß√£o segura de usu√°rios √© via Firebase Console (Authentication) + libera√ß√£o no Firestore.</div>
            <div class="small muted" style="margin-top:8px">
              Dica: a dupla cria login no Authentication, faz login 1x, e voc√™ libera o UID em <b>Firestore &gt; users</b>.
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="card">
          <h2>Vis√£o geral</h2>

          <div class="kpis">
            <div class="kpi blue">
              <div class="label">Total</div>
              <div id="kpiTotal" class="val">0</div>
              <div class="hint">na vis√£o atual</div>
            </div>
            <div class="kpi green">
              <div class="label">Eleg√≠veis</div>
              <div id="kpiElig" class="val">0</div>
              <div class="hint">eleg√≠vel=Sim</div>
            </div>
            <div class="kpi red">
              <div class="label">N√£o eleg√≠veis</div>
              <div id="kpiNaoElig" class="val">0</div>
              <div class="hint">eleg√≠vel=N√£o</div>
            </div>
            <div class="kpi yellow">
              <div class="label">TCLE assinado</div>
              <div id="kpiTCLE" class="val">0</div>
              <div class="hint">tcleAssinado=Sim</div>
            </div>

            <div class="kpi blue">
              <div class="label">Encaminhadores</div>
              <div id="kpiEnc" class="val">0</div>
              <div class="hint">encaminhador preenchido</div>
            </div>
            <div class="kpi green">
              <div class="label">Randomizados</div>
              <div id="kpiRand" class="val">0</div>
              <div class="hint">status=Randomizado</div>
            </div>
            <div class="kpi red">
              <div class="label">Falha de screening</div>
              <div id="kpiFail" class="val">0</div>
              <div class="hint">status=Falha de screening</div>
            </div>
            <div class="kpi yellow">
              <div class="label">Convers√£o</div>
              <div id="kpiConv" class="val">0%</div>
              <div class="hint">Rand / Eleg√≠veis</div>
            </div>
          </div>

          <div style="margin-top:12px" class="formgrid">
            <div class="field">
              <label>Busca</label>
              <input id="search" placeholder="nome / status / estudo / encaminhador" />
            </div>
            <div class="field">
              <label>M√™s</label>
              <input id="monthFilter" type="month" />
            </div>
            <div class="field">
              <label>Status</label>
              <select id="statusFilter">
                <option value="">Todos</option>
                <option>Em avalia√ß√£o</option>
                <option>Pr√©-screening</option>
                <option>Screening</option>
                <option>Randomizado</option>
                <option>Falha de screening</option>
              </select>
            </div>
            <div class="field">
              <label>A√ß√µes</label>
              <div class="row">
                <button id="clearMonthBtn" class="ghost">Limpar m√™s</button>
                <button id="exportBtn" class="ghost">Exportar CSV</button>
                <button id="exportPdfBtn" class="ghost">Baixar PDF</button>
              </div>
            </div>
          </div>

          <div class="sep"></div>

          <h2>Indicadores (gr√°fico)</h2>
          <canvas id="statusChart" height="150"></canvas>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <h2>Pacientes</h2>
        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Status</th>
                <th>Estudo</th>
                <th>Encaminhador</th>
                <th>Eleg√≠vel</th>
                <th>Motivo</th>
                <th>Data</th>
                <th>TCLE</th>
                <th class="nowrap">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
        <div id="emptyMsg" class="small muted" style="margin-top:10px"></div>
      </div>
    </div>

    <!-- SCREENING -->
    <div id="viewScreen" class="hidden">
      <div class="card">
        <div class="calHeader">
          <div>
            <h2>Screening ‚Äî Calend√°rio (m√™s atual + pr√≥ximos)</h2>
            <div class="small muted">Cadastre procedimentos por dia e vincule ao paciente. Alertas: hoje e amanh√£ (na tela) + opcional do navegador.</div>
          </div>
          <div class="row">
            <button id="prevMonthBtn" class="ghost">‚óÄ M√™s</button>
            <span class="chip" id="calTitle">‚Äî</span>
            <button id="nextMonthBtn" class="ghost">M√™s ‚ñ∂</button>
          </div>
        </div>

        <div class="sep"></div>

        <div class="calSide">
          <div>
            <div class="calGrid" id="calDows"></div>
            <div class="calGrid" id="calGrid"></div>
          </div>

          <div>
            <div class="noteBox">
              <h2 style="margin-bottom:6px">Novo procedimento</h2>
              <div class="small muted" id="pickedDayLabel">Selecione um dia no calend√°rio.</div>

              <div class="formgrid" style="margin-top:10px">
                <div class="field full">
                  <label>Paciente</label>
                  <select id="scrPatient"></select>
                </div>
                <div class="field">
                  <label>Tipo</label>
                  <select id="scrType">
                    <option value="">Selecione</option>
                    <option>Consulta</option>
                    <option>Exame laboratorial</option>
                    <option>Imagem (TC/RM/PET)</option>
                    <option>Procedimento (bi√≥psia/medula)</option>
                    <option>Envio para central</option>
                    <option>Assinatura TCLE</option>
                    <option>Outro</option>
                  </select>
                </div>
                <div class="field">
                  <label>Hora (opcional)</label>
                  <input id="scrTime" type="time" />
                </div>
                <div class="field full">
                  <label>Descri√ß√£o</label>
                  <input id="scrTitle" placeholder="Ex: PET-CT / Hemograma / Consulta Dr. X" />
                </div>
                <div class="field full">
                  <label>Notas</label>
                  <textarea id="scrNotes" placeholder="Observa√ß√£o interna (sem dados sens√≠veis desnecess√°rios)"></textarea>
                </div>
              </div>

              <div class="actions">
                <button id="scrSaveBtn" class="ok">Salvar procedimento</button>
                <button id="scrClearBtn" class="ghost">Limpar</button>
              </div>
            </div>

            <div class="sep"></div>

            <h2>Pr√≥ximos alertas</h2>
            <div class="listMini" id="alertsBox"></div>
          </div>
        </div>

        <div class="sep"></div>

        <h2>Procedimentos do m√™s</h2>
        <div class="tablewrap">
          <table style="min-width:980px">
            <thead>
              <tr>
                <th>Data</th>
                <th>Paciente</th>
                <th>Tipo</th>
                <th>Descri√ß√£o</th>
                <th>Notas</th>
                <th class="nowrap">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="scrTableBody"></tbody>
          </table>
        </div>
        <div id="scrEmptyMsg" class="small muted" style="margin-top:10px"></div>
      </div>
    </div>

  </div>

  <div id="toast" class="toast hidden"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, doc, setDoc, deleteDoc, getDoc,
    onSnapshot, query, orderBy, serverTimestamp, where, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // ======= firebaseConfig (SEU) =======
  const firebaseConfig = {
    apiKey: "AIzaSyCvoVAWsVMYfAQv-pISsn7mNfdInIjLDFo",
    authDomain: "iep-recrutamento.firebaseapp.com",
    projectId: "iep-recrutamento",
    storageBucket: "iep-recrutamento.firebasestorage.app",
    messagingSenderId: "297731374831",
    appId: "1:297731374831:web:684eed6683602d6c3fe51a",
    measurementId: "G-8ST5S7FWE0"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // ======= Estado =======
  let DB = [];              // patients
  let EVENTS = [];          // screening_events (range por m√™s)
  let CHART = null;
  let editId = null;

  let CURRENT_USER = null;
  let CURRENT_ROLE = null;   // "admin" | "assistant"
  let IS_ACTIVE = false;

  const DOWS = ["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"];
  let calBase = new Date(); calBase.setDate(1);
  let pickedDateISO = "";

  let unsubPatients = null;
  let unsubEvents = null;

  // ======= Helpers =======
  const $ = (id) => document.getElementById(id);
  const esc = (s) => (s ?? "").toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  const uid = () => "p_" + Date.now().toString(36) + Math.random().toString(36).slice(2,8);
  const uidEv = () => "e_" + Date.now().toString(36) + Math.random().toString(36).slice(2,8);

  function toast(msg, err=false){
    const t = $("toast");
    t.textContent = msg;
    t.classList.remove("hidden");
    t.classList.toggle("err", !!err);
    setTimeout(()=>t.classList.add("hidden"), 2400);
  }

  function iso(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }
  function parseMonth(v){
    if(!v) return null;
    const [y,m] = v.split("-").map(Number);
    return {y,m};
  }
  function inMonth(dateStr, sel){
    if(!sel) return true;
    if(!dateStr) return false;
    const d = new Date(dateStr);
    return d.getFullYear()===sel.y && (d.getMonth()+1)===sel.m;
  }
  function addMonths(d, n){
    const x = new Date(d);
    x.setMonth(x.getMonth()+n);
    x.setDate(1);
    return x;
  }
  function startOfMonth(d){
    const x = new Date(d);
    x.setDate(1); x.setHours(0,0,0,0);
    return x;
  }
  function endOfMonth(d){
    const x = new Date(d);
    x.setMonth(x.getMonth()+1);
    x.setDate(0); x.setHours(23,59,59,999);
    return x;
  }

  // ======= Tabs =======
  function setTab(which){
    const isRecruit = which === "recruit";
    $("tabRecruit").classList.toggle("active", isRecruit);
    $("tabScreen").classList.toggle("active", !isRecruit);
    $("viewRecruit").classList.toggle("hidden", !isRecruit);
    $("viewScreen").classList.toggle("hidden", isRecruit);
    if(!isRecruit) refreshScreeningUI();
  }
  $("tabRecruit").onclick = () => setTab("recruit");
  $("tabScreen").onclick = () => setTab("screen");

  // ======= Notifica√ß√µes (opcional navegador) =======
  function canNotify(){ return "Notification" in window; }
  function setNotiChip(){
    if(!canNotify()) return $("notiChip").textContent = "Notifica√ß√µes: internas";
    const perm = Notification.permission;
    if(perm === "granted") $("notiChip").textContent = "Notifica√ß√µes: navegador + internas";
    else if(perm === "denied") $("notiChip").textContent = "Notifica√ß√µes: internas (bloqueadas no navegador)";
    else $("notiChip").textContent = "Notifica√ß√µes: internas (navegador n√£o ativado)";
  }
  $("enableNotiBtn").addEventListener("click", async ()=>{
    if(!canNotify()) return toast("Seu navegador n√£o suporta Notification API", true);
    try{
      const perm = await Notification.requestPermission();
      setNotiChip();
      if(perm === "granted") toast("Notifica√ß√µes do navegador ativadas!");
      else toast("Notifica√ß√£o do navegador n√£o foi liberada.", true);
    }catch{
      toast("N√£o foi poss√≠vel ativar notifica√ß√£o do navegador.", true);
    }
  });
  setNotiChip();
  function pushBrowserNotification(title, body){
    if(!canNotify()) return;
    if(Notification.permission !== "granted") return;
    try{ new Notification(title, { body }); }catch{}
  }

  // ======= UI toggles =======
  function toggleOutroEnc(){
    const v = $("encaminhador").value;
    $("wrapOutroEnc").classList.toggle("hidden", v !== "Outro");
    if(v !== "Outro") $("outroEncaminhador").value = "";
  }
  function toggleOutroMotivo(){
    const v = $("motivoNaoElegivel").value;
    $("wrapOutroMotivo").classList.toggle("hidden", v !== "Outro");
    if(v !== "Outro") $("outroMotivo").value = "";
  }
  $("encaminhador").addEventListener("change", toggleOutroEnc);
  $("motivoNaoElegivel").addEventListener("change", toggleOutroMotivo);
  $("elegivel").addEventListener("change", () => {
    const isNo = $("elegivel").value === "N√£o";
    $("motivoNaoElegivel").disabled = !isNo;
    $("outroMotivo").disabled = !isNo;
    if(!isNo){
      $("motivoNaoElegivel").value = "";
      $("outroMotivo").value = "";
      toggleOutroMotivo();
    }
  });

  // ======= Auth =======
  async function login(){
    const email = $("emailLogin").value.trim();
    const pass = $("passwordLogin").value;
    if(!email || !pass) return toast("Informe email e senha", true);
    try{ await signInWithEmailAndPassword(auth, email, pass); }
    catch(e){ toast("Erro no login: " + (e?.message || e), true); }
  }
  async function logout(){ await signOut(auth); }
  $("loginBtn").addEventListener("click", login);
  $("logoutBtn").addEventListener("click", logout);

  function setAuthUI(logged){
    $("logoutBtn").classList.toggle("hidden", !logged);
    $("loginBtn").classList.toggle("hidden", logged);
    $("emailLogin").disabled = logged;
    $("passwordLogin").disabled = logged;
  }

  async function getRole(uid){
    const snap = await getDoc(doc(db,"users",uid));
    if(!snap.exists()) return {active:false, role:null};
    const data = snap.data() || {};
    return { active: !!data.active, role: data.role || null };
  }

  // ======= Firestore realtime =======
  function startRealtimePatients(){
    const q = query(collection(db, "patients"), orderBy("data","desc"));
    return onSnapshot(q, (snap)=>{
      DB = snap.docs.map(d => d.data());
      refreshUI();
      refreshScreeningUI();
    }, ()=> toast("Erro ao sincronizar pacientes", true));
  }

  function startRealtimeEventsForCalendar(){
    const from = iso(startOfMonth(calBase));
    const to = iso(endOfMonth(addMonths(calBase, 1))); // m√™s atual + pr√≥ximo

    const q = query(
      collection(db, "screening_events"),
      where("date", ">=", from),
      where("date", "<=", to)
    );

    return onSnapshot(q, (snap)=>{
      EVENTS = snap.docs.map(d=>d.data()).sort((a,b)=>(a.date||"").localeCompare(b.date||""));
      refreshScreeningUI();
      buildAlerts();
    }, ()=> toast("Erro ao sincronizar screening", true));
  }

  onAuthStateChanged(auth, async (user)=>{
    CURRENT_USER = user || null;

    if(unsubPatients){ unsubPatients(); unsubPatients=null; }
    if(unsubEvents){ unsubEvents(); unsubEvents=null; }

    if(!user){
      setAuthUI(false);
      CURRENT_ROLE=null; IS_ACTIVE=false;
      $("roleChip").textContent = "N√£o autenticado";
      $("accessHint").textContent = "Fa√ßa login para salvar.";
      $("adminPanel").classList.add("hidden");
      DB=[]; EVENTS=[];
      refreshUI(); refreshScreeningUI();
      return;
    }

    setAuthUI(true);

    const info = await getRole(user.uid);
    CURRENT_ROLE = info.role;
    IS_ACTIVE = info.active;

    if(!IS_ACTIVE){
      $("roleChip").textContent = "Aguardando libera√ß√£o";
      $("accessHint").textContent = "Seu acesso n√£o est√° ativo (admin precisa liberar).";
      $("adminPanel").classList.add("hidden");
      DB=[]; EVENTS=[];
      refreshUI(); refreshScreeningUI();
      toast("Acesso n√£o liberado ainda.", true);
      return;
    }

    $("roleChip").textContent = `${user.email} ‚Ä¢ ${CURRENT_ROLE || "sem role"}`;
    $("accessHint").textContent = (CURRENT_ROLE === "admin")
      ? "Admin: pode criar/editar/excluir"
      : "Assistente: pode criar/editar (n√£o exclui)";
    $("adminPanel").classList.toggle("hidden", CURRENT_ROLE !== "admin");

    unsubPatients = startRealtimePatients();
    unsubEvents = startRealtimeEventsForCalendar();
    toast("Conectado (online)!");
  });

  // ======= Recrutamento: Form =======
  function validate(){
    const req = ["nome","status","estudo","data"];
    for(const id of req){
      if(!$(id).value.trim()){
        toast("Preencha Nome, Status, Estudo e Data", true);
        return false;
      }
    }
    return true;
  }

  function buildRec(){
    const enc = ($("encaminhador").value === "Outro")
      ? ($("outroEncaminhador").value.trim() || "Outro")
      : $("encaminhador").value;

    const isNo = $("elegivel").value === "N√£o";
    const motivo = isNo
      ? (($("motivoNaoElegivel").value === "Outro")
          ? ($("outroMotivo").value.trim() || "Outro")
          : $("motivoNaoElegivel").value)
      : "";

    return {
      id: editId || uid(),
      nome: $("nome").value.trim(),
      status: $("status").value.trim(),
      estudo: $("estudo").value.trim(),
      data: $("data").value,
      encaminhador: enc || "",
      tcleAgendado: $("tcleAgendado").value,
      tcleAssinado: $("tcleAssinado").value,
      elegivel: $("elegivel").value,
      motivoNaoElegivel: motivo || "",
      obs: $("obs").value.trim()
    };
  }

  async function save(){
    if(!CURRENT_USER || !IS_ACTIVE) return toast("Sem acesso. Fa√ßa login.", true);
    if(!validate()) return;

    const rec = buildRec();
    try{
      await setDoc(doc(db,"patients",rec.id), {
        ...rec,
        updatedAt: serverTimestamp(),
        updatedBy: CURRENT_USER.uid
      }, {merge:true});

      resetForm();
      toast("Salvo!");
    }catch(e){
      toast("Falha ao salvar: " + (e?.message||e), true);
    }
  }

  function resetForm(){
    editId = null;
    $("nome").value = "";
    $("status").value = "";
    $("estudo").value = "";
    $("data").value = "";
    $("encaminhador").value = "";
    $("outroEncaminhador").value = "";
    $("tcleAgendado").value = "N√£o";
    $("tcleAssinado").value = "N√£o";
    $("elegivel").value = "Sim";
    $("motivoNaoElegivel").value = "";
    $("outroMotivo").value = "";
    $("obs").value = "";
    toggleOutroEnc();
    toggleOutroMotivo();
    $("cancelBtn").classList.add("hidden");
  }

  function fillForm(p){
    editId = p.id;
    $("nome").value = p.nome || "";
    $("status").value = p.status || "";
    $("estudo").value = p.estudo || "";
    $("data").value = p.data || "";
    $("tcleAgendado").value = p.tcleAgendado || "N√£o";
    $("tcleAssinado").value = p.tcleAssinado || "N√£o";
    $("elegivel").value = p.elegivel || "Sim";
    $("obs").value = p.obs || "";

    const knownEnc = ["Dr. Milton","Dr. H√©lio","Dr. Thiago","ALTY"];
    if(p.encaminhador && knownEnc.includes(p.encaminhador)){
      $("encaminhador").value = p.encaminhador;
      $("outroEncaminhador").value = "";
    } else if(p.encaminhador){
      $("encaminhador").value = "Outro";
      $("outroEncaminhador").value = p.encaminhador;
    } else {
      $("encaminhador").value = "";
      $("outroEncaminhador").value = "";
    }
    toggleOutroEnc();

    const isNo = (p.elegivel === "N√£o");
    $("motivoNaoElegivel").disabled = !isNo;
    $("outroMotivo").disabled = !isNo;

    if(isNo){
      const knownMot = ["Progress√£o","Perda de follow-up","Recusa do paciente","Outro"];
      if(p.motivoNaoElegivel && knownMot.includes(p.motivoNaoElegivel)){
        $("motivoNaoElegivel").value = p.motivoNaoElegivel;
        $("outroMotivo").value = "";
      } else if(p.motivoNaoElegivel){
        $("motivoNaoElegivel").value = "Outro";
        $("outroMotivo").value = p.motivoNaoElegivel;
      } else {
        $("motivoNaoElegivel").value = "";
        $("outroMotivo").value = "";
      }
    } else {
      $("motivoNaoElegivel").value = "";
      $("outroMotivo").value = "";
    }
    toggleOutroMotivo();

    $("cancelBtn").classList.remove("hidden");
  }

  async function removePatient(id){
    if(!CURRENT_USER || !IS_ACTIVE) return toast("Sem acesso.", true);
    if(CURRENT_ROLE !== "admin") return toast("Assistente n√£o pode excluir.", true);
    if(!confirm("Excluir este registro?")) return;

    try{
      await deleteDoc(doc(db,"patients",id));
      toast("Exclu√≠do.");
    }catch(e){
      toast("Falha ao excluir: " + (e?.message||e), true);
    }
  }

  $("saveBtn").addEventListener("click", save);
  $("cancelBtn").addEventListener("click", () => { resetForm(); toast("Edi√ß√£o cancelada"); });

  // ======= Recrutamento: Dataset/Filtros =======
  function dataset(){
    const q = ($("search").value || "").toLowerCase();
    const selMonth = parseMonth($("monthFilter").value);
    const st = ($("statusFilter").value || "").toLowerCase();

    return DB
      .filter(p=>{
        const hitQ = !q
          || (p.nome||"").toLowerCase().includes(q)
          || (p.status||"").toLowerCase().includes(q)
          || (p.estudo||"").toLowerCase().includes(q)
          || (p.encaminhador||"").toLowerCase().includes(q);

        const hitM = inMonth(p.data, selMonth);
        const hitS = !st || (p.status||"").toLowerCase()===st;

        return hitQ && hitM && hitS;
      })
      .sort((a,b)=> (b.data||"").localeCompare(a.data||""));
  }

  function updateKPIs(list){
    const total = list.length;
    const elig = list.filter(x=>x.elegivel==="Sim").length;
    const nao = list.filter(x=>x.elegivel==="N√£o").length;
    const tcle = list.filter(x=>x.tcleAssinado==="Sim").length;
    const enc = list.filter(x=>(x.encaminhador||"").trim().length>0).length;
    const rand = list.filter(x=>x.status==="Randomizado").length;
    const fail = list.filter(x=>x.status==="Falha de screening").length;
    const conv = elig ? Math.round((rand/elig)*100) : 0;

    $("kpiTotal").textContent = total;
    $("kpiElig").textContent = elig;
    $("kpiNaoElig").textContent = nao;
    $("kpiTCLE").textContent = tcle;
    $("kpiEnc").textContent = enc;
    $("kpiRand").textContent = rand;
    $("kpiFail").textContent = fail;
    $("kpiConv").textContent = `${conv}%`;
  }

  function updateChart(list){
    // gr√°fico com TODOS os indicadores que voc√™ citou
    const total = list.length;
    const elig = list.filter(x=>x.elegivel==="Sim").length;
    const nao = list.filter(x=>x.elegivel==="N√£o").length;
    const tcle = list.filter(x=>x.tcleAssinado==="Sim").length;
    const enc = list.filter(x=>(x.encaminhador||"").trim().length>0).length;
    const rand = list.filter(x=>x.status==="Randomizado").length;
    const fail = list.filter(x=>x.status==="Falha de screening").length;

    const labels = ["Total","Eleg√≠veis","N√£o eleg√≠veis","TCLE assinado","Encaminhadores","Randomizados","Falha de screening"];
    const data = [total, elig, nao, tcle, enc, rand, fail];

    const ctx = $("statusChart").getContext("2d");
    if(CHART) CHART.destroy();
    CHART = new Chart(ctx, {
      type:"bar",
      data:{ labels, datasets:[{ data }] },
      options:{
        plugins:{ legend:{ display:false } },
        scales:{
          y:{ beginAtZero:true, ticks:{ precision:0 } }
        }
      }
    });
  }

  function renderTable(){
    const tbody = $("tableBody");
    const list = dataset();
    tbody.innerHTML = "";

    for(const r of list){
      const tagElig = (r.elegivel==="Sim") ? `<span class="tag ok">Sim</span>` : `<span class="tag no">N√£o</span>`;
      const tagTCLE = (r.tcleAssinado==="Sim") ? `<span class="tag ok">Sim</span>` : `<span class="tag">N√£o</span>`;

      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>
            <div>${esc(r.nome)}</div>
            ${r.obs ? `<div class="small">${esc(r.obs)}</div>` : ``}
          </td>
          <td>${esc(r.status)}</td>
          <td>${esc(r.estudo)}</td>
          <td>${esc(r.encaminhador)}</td>
          <td>${tagElig}</td>
          <td>${esc(r.motivoNaoElegivel || "-")}</td>
          <td class="nowrap">${esc(r.data)}</td>
          <td>${tagTCLE}</td>
          <td class="nowrap">
            <button class="btn" data-edit="${esc(r.id)}">‚úèÔ∏è</button>
            <button class="danger" data-del="${esc(r.id)}">üóëÔ∏è</button>
          </td>
        </tr>
      `);
    }

    $("emptyMsg").textContent = list.length ? "" : "Sem registros para esta vis√£o.";
    updateKPIs(list);
    updateChart(list);

    document.querySelectorAll("[data-edit]").forEach(b=>{
      b.onclick = () => {
        const id = b.getAttribute("data-edit");
        const p = DB.find(x=>x.id===id);
        if(p) fillForm(p);
      };
    });
    document.querySelectorAll("[data-del]").forEach(b=>{
      b.onclick = () => removePatient(b.getAttribute("data-del"));
    });
  }

  function refreshUI(){ renderTable(); }

  ["search","monthFilter","statusFilter"].forEach(id=>{
    $(id).addEventListener("input", refreshUI);
    $(id).addEventListener("change", refreshUI);
  });

  $("clearMonthBtn").addEventListener("click", ()=>{
    $("monthFilter").value = "";
    refreshUI();
  });

  // ======= Export CSV =======
  $("exportBtn").addEventListener("click", ()=>{
    const rows = dataset();
    const header = ["id","nome","status","estudo","data","encaminhador","tcleAgendado","tcleAssinado","elegivel","motivoNaoElegivel","obs"];
    const csv = [
      header.join(","),
      ...rows.map(r => header.map(h => `"${String(r[h] ?? "").replaceAll('"','""')}"`).join(","))
    ].join("\n");

    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "iep_recrutamento_export.csv";
    a.click();
    URL.revokeObjectURL(url);
  });

  // ======= Export PDF (bonito) =======
  $("exportPdfBtn").addEventListener("click", ()=>{
    const rows = dataset();
    const { jsPDF } = window.jspdf;
    const docPdf = new jsPDF({ orientation:"landscape", unit:"pt", format:"a4" });

    const today = new Date();
    const title = "IEP Recrutamento ‚Äî Indicadores";
    docPdf.setFont("helvetica","bold");
    docPdf.setFontSize(16);
    docPdf.text(title, 40, 40);

    docPdf.setFont("helvetica","normal");
    docPdf.setFontSize(10);
    docPdf.text(`Gerado em: ${today.toLocaleString("pt-BR")}`, 40, 60);

    // KPIs
    const total = rows.length;
    const elig = rows.filter(x=>x.elegivel==="Sim").length;
    const nao = rows.filter(x=>x.elegivel==="N√£o").length;
    const tcle = rows.filter(x=>x.tcleAssinado==="Sim").length;
    const enc = rows.filter(x=>(x.encaminhador||"").trim().length>0).length;
    const rand = rows.filter(x=>x.status==="Randomizado").length;
    const fail = rows.filter(x=>x.status==="Falha de screening").length;
    const conv = elig ? Math.round((rand/elig)*100) : 0;

    docPdf.setFont("helvetica","bold");
    docPdf.setFontSize(11);
    docPdf.text(`Total: ${total}  |  Eleg√≠veis: ${elig}  |  N√£o eleg√≠veis: ${nao}  |  TCLE assinado: ${tcle}  |  Encaminhadores: ${enc}  |  Randomizados: ${rand}  |  Falha: ${fail}  |  Convers√£o: ${conv}%`, 40, 85);

    // Gr√°fico
    const canvas = document.getElementById("statusChart");
    try{
      const img = canvas.toDataURL("image/png", 1.0);
      docPdf.addImage(img, "PNG", 40, 100, 520, 210);
    }catch{}

    // Resumo por estudo (n√∫mero e por estudo)
    const byStudy = {};
    for(const r of rows){
      const s = (r.estudo||"Sem estudo").trim();
      if(!byStudy[s]) byStudy[s] = { total:0, elig:0, rand:0, fail:0 };
      byStudy[s].total++;
      if(r.elegivel==="Sim") byStudy[s].elig++;
      if(r.status==="Randomizado") byStudy[s].rand++;
      if(r.status==="Falha de screening") byStudy[s].fail++;
    }
    const studyTable = Object.entries(byStudy).map(([study, v]) => ([
      study, v.total, v.elig, v.rand, v.fail, (v.elig? Math.round((v.rand/v.elig)*100):0) + "%"
    ]));

    docPdf.setFont("helvetica","bold");
    docPdf.setFontSize(12);
    docPdf.text("Resumo por estudo", 580, 120);

    docPdf.autoTable({
      startY: 135,
      margin: { left: 580, right: 40 },
      head: [["Estudo","Total","Eleg√≠veis","Rand.","Falha","Conv."]],
      body: studyTable,
      styles: { fontSize: 9, cellPadding: 4 },
      headStyles: { fillColor: [16,19,27] }
    });

    // P√°gina 2: Individual por paciente (vis√£o atual)
    docPdf.addPage("a4","landscape");
    docPdf.setFont("helvetica","bold");
    docPdf.setFontSize(14);
    docPdf.text("Pacientes ‚Äî vis√£o atual", 40, 40);

    const body = rows.map(r => ([
      r.nome||"",
      r.status||"",
      r.estudo||"",
      r.encaminhador||"",
      r.elegivel||"",
      r.motivoNaoElegivel||"",
      r.data||"",
      r.tcleAssinado||"",
      (r.obs||"").slice(0,80)
    ]));

    docPdf.autoTable({
      startY: 60,
      margin: { left: 40, right: 40 },
      head: [["Nome","Status","Estudo","Enc.","Eleg√≠vel","Motivo","Data","TCLE","Obs"]],
      body,
      styles: { fontSize: 8, cellPadding: 3 },
      headStyles: { fillColor: [16,19,27] }
    });

    docPdf.save("IEP_Indicadores.pdf");
  });

  // ======= Screening: Calendar UI =======
  function ensureDows(){
    const el = $("calDows");
    if(el.children.length) return;
    for(const d of DOWS){
      const x = document.createElement("div");
      x.className = "calDow";
      x.textContent = d;
      el.appendChild(x);
    }
  }

  function renderCalendar(){
    ensureDows();

    const monthName = calBase.toLocaleString("pt-BR",{ month:"long", year:"numeric" });
    $("calTitle").textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);

    const grid = $("calGrid");
    grid.innerHTML = "";

    const firstDay = new Date(calBase);
    const startDow = firstDay.getDay();

    const daysInMonth = new Date(calBase.getFullYear(), calBase.getMonth()+1, 0).getDate();

    // blanks
    for(let i=0;i<startDow;i++){
      const blank = document.createElement("div");
      blank.className="calDay";
      blank.style.opacity = ".18";
      blank.style.cursor = "default";
      blank.innerHTML = "<div class='n'> </div>";
      grid.appendChild(blank);
    }

    const todayISO = iso(new Date());
    const map = {};
    for(const e of EVENTS){
      map[e.date] = map[e.date] || [];
      map[e.date].push(e);
    }

    for(let d=1; d<=daysInMonth; d++){
      const dt = new Date(calBase.getFullYear(), calBase.getMonth(), d);
      const dtISO = iso(dt);

      const box = document.createElement("div");
      box.className = "calDay";
      if(dtISO === todayISO) box.classList.add("today");
      if(map[dtISO] && map[dtISO].length) box.classList.add("has");

      box.innerHTML = `<div class="n">${d}</div>`;
      if(map[dtISO] && map[dtISO].length){
        const first = map[dtISO][0];
        const label = `${first.title || first.type || "Procedimento"} ‚Ä¢ ${first.patientName || ""}`.trim();
        const pill = document.createElement("div");
        pill.className="pill";
        pill.textContent = map[dtISO].length>1 ? `${label} +${map[dtISO].length-1}` : label;
        box.appendChild(pill);
      }

      box.onclick = () => {
        pickedDateISO = dtISO;
        $("pickedDayLabel").textContent = `Dia selecionado: ${dt.toLocaleDateString("pt-BR")}`;
      };

      grid.appendChild(box);
    }
  }

  function fillPatientsDropdown(){
    const sel = $("scrPatient");
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "Selecione";
    sel.appendChild(opt0);

    const list = [...DB].sort((a,b)=>(a.nome||"").localeCompare(b.nome||""));
    for(const p of list){
      const o = document.createElement("option");
      o.value = p.id;
      o.textContent = `${p.nome || p.id} ‚Äî ${p.estudo || ""}`.trim();
      sel.appendChild(o);
    }
  }

  function listEventsOfCurrentMonth(){
    const from = iso(startOfMonth(calBase));
    const to = iso(endOfMonth(calBase));
    const monthEvents = EVENTS.filter(e => (e.date||"") >= from && (e.date||"") <= to);

    const tbody = $("scrTableBody");
    tbody.innerHTML = "";

    for(const e of monthEvents){
      const canDel = (CURRENT_ROLE === "admin");
      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td class="nowrap">${esc(e.date)} ${esc(e.time||"")}</td>
          <td>${esc(e.patientName||"")}</td>
          <td>${esc(e.type||"")}</td>
          <td>${esc(e.title||"")}</td>
          <td>${esc(e.notes||"")}</td>
          <td class="nowrap">
            ${canDel ? `<button class="danger" data-evdel="${esc(e.id)}">üóëÔ∏è</button>` : `<span class="small muted">‚Äî</span>`}
          </td>
        </tr>
      `);
    }

    $("scrEmptyMsg").textContent = monthEvents.length ? "" : "Sem procedimentos no m√™s.";
    document.querySelectorAll("[data-evdel]").forEach(b=>{
      b.onclick = () => deleteEvent(b.getAttribute("data-evdel"));
    });
  }

  function resetScrForm(){
    $("scrPatient").value = "";
    $("scrType").value = "";
    $("scrTime").value = "";
    $("scrTitle").value = "";
    $("scrNotes").value = "";
  }
  $("scrClearBtn").onclick = resetScrForm;

  async function saveEvent(){
    if(!CURRENT_USER || !IS_ACTIVE) return toast("Sem acesso. Fa√ßa login.", true);
    if(!pickedDateISO) return toast("Selecione um dia no calend√°rio.", true);

    const patientId = $("scrPatient").value;
    const type = $("scrType").value;
    const time = $("scrTime").value;
    const title = $("scrTitle").value.trim();
    const notes = $("scrNotes").value.trim();

    if(!patientId || !type || !title) return toast("Preencha Paciente, Tipo e Descri√ß√£o.", true);

    const p = DB.find(x=>x.id===patientId);
    const ev = {
      id: uidEv(),
      date: pickedDateISO,
      time: time || "",
      patientId,
      patientName: p?.nome || patientId,
      type,
      title,
      notes,
      createdAt: serverTimestamp(),
      createdBy: CURRENT_USER.uid,
      updatedAt: serverTimestamp(),
      updatedBy: CURRENT_USER.uid
    };

    try{
      await setDoc(doc(db,"screening_events",ev.id), ev, {merge:true});

      // atualiza o paciente automaticamente (campo-resumo)
      await setDoc(doc(db,"patients",patientId), {
        screeningLastUpdate: serverTimestamp(),
        screeningLastEventDate: pickedDateISO,
        screeningLastEventTitle: title
      }, {merge:true});

      resetScrForm();
      toast("Procedimento salvo!");
    }catch(e){
      toast("Erro ao salvar procedimento: " + (e?.message||e), true);
    }
  }
  $("scrSaveBtn").onclick = saveEvent;

  async function deleteEvent(id){
    if(CURRENT_ROLE !== "admin") return toast("Somente admin pode excluir.", true);
    if(!confirm("Excluir este procedimento?")) return;
    try{
      await deleteDoc(doc(db,"screening_events",id));
      toast("Procedimento exclu√≠do.");
    }catch(e){
      toast("Erro ao excluir: " + (e?.message||e), true);
    }
  }

  function buildAlerts(){
    const box = $("alertsBox");
    box.innerHTML = "";

    const today = new Date();
    const t0 = iso(today);
    const t1 = iso(new Date(today.getFullYear(), today.getMonth(), today.getDate()+1));

    const due = EVENTS.filter(e => e.date===t0 || e.date===t1)
                      .sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));

    if(!due.length){
      box.innerHTML = `<div class="mini"><b>Nenhum alerta</b><div class="small muted">Sem procedimentos para hoje/amanh√£.</div></div>`;
      return;
    }

    for(const e of due){
      const when = e.date===t0 ? "HOJE" : "AMANH√É";
      const line = `${when} ‚Ä¢ ${e.date} ${e.time||""} ‚Äî ${e.title||e.type} ‚Äî ${e.patientName||""}`;
      const card = document.createElement("div");
       card.className = "mini";
      card.innerHTML = `<b>${esc(e.title || e.type || "Procedimento")}</b>
        <div class="small muted">${esc(line)}</div>`;
      box.appendChild(card);
    }

    // Notifica√ß√£o do navegador (1x por sess√£o) ‚Äì simples e segura
    try{
      const key = "iep_notified_" + t0;
      if(!sessionStorage.getItem(key)){
        const todayEvents = due.filter(e=>e.date===t0);
        if(todayEvents.length){
          pushBrowserNotification("IEP Screening ‚Äî HOJE", `${todayEvents.length} procedimento(s) hoje.`);
        }
        sessionStorage.setItem(key, "1");
      }
    }catch{}
  }

  function refreshScreeningUI(){
    fillPatientsDropdown();
    renderCalendar();
    listEventsOfCurrentMonth();
    buildAlerts();
  }

  $("prevMonthBtn").onclick = ()=>{
    calBase = addMonths(calBase, -1);
    // re-subscrever eventos (m√™s atual + pr√≥ximo)
    if(unsubEvents){ unsubEvents(); unsubEvents = startRealtimeEventsForCalendar(); }
    refreshScreeningUI();
  };
  $("nextMonthBtn").onclick = ()=>{
    calBase = addMonths(calBase, 1);
    if(unsubEvents){ unsubEvents(); unsubEvents = startRealtimeEventsForCalendar(); }
    refreshScreeningUI();
  };

  // ======= Admin: criar usu√°rio (orienta√ß√£o + atalho) =======
  // Aqui deixo s√≥ um alerta (mais seguro). Voc√™ cria no Firebase Console > Authentication.
  // Depois libera o UID em Firestore > users/{uid}.
  // Se voc√™ quiser, depois eu te passo a vers√£o com Cloud Function (admin cria pelo painel).
  // -----------------------------------
  // Ajuste inicial
  $("motivoNaoElegivel").disabled = true;
  $("outroMotivo").disabled = true;
  toggleOutroEnc();
  toggleOutroMotivo();
  refreshUI();
  refreshScreeningUI();
</script>

</body>
</html>

<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IEP Recrutamento ‚Äî Online</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      /* NOVA PALETA (azul/teal clean) */
      --bg:#0a0f1f;
      --panel:#0f172a;
      --panel2:#0b1224;
      --line:#22304a;
      --text:#eef2ff;
      --muted:#a7b0c5;
      --blue:#3b82f6;
      --teal:#14b8a6;
      --green:#22c55e;
      --yellow:#fbbf24;
      --red:#ef4444;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(59,130,246,.18), transparent 55%),
        radial-gradient(900px 700px at 90% 20%, rgba(20,184,166,.12), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    a{color:var(--blue)}
    .wrap{max-width:1200px;margin:26px auto;padding:0 14px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 16px;border:1px solid var(--line);border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      backdrop-filter: blur(8px);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:44px;height:44px;border-radius:12px;background:rgba(59,130,246,.14);
      display:grid;place-items:center;border:1px solid rgba(59,130,246,.28);
    }
    .brand h1{font-size:16px;margin:0}
    .brand small{display:block;color:var(--muted);margin-top:2px;font-size:12px}

    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input,select,button,textarea{
      font:inherit;
      background:var(--panel2);
      color:var(--text);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
    }
    input::placeholder{color:#7782a0}
    button{cursor:pointer}
    .btn{background:rgba(59,130,246,.16);border-color:rgba(59,130,246,.38)}
    .btn:hover{background:rgba(59,130,246,.24)}
    .ghost{background:transparent}
    .danger{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35)}
    .danger:hover{background:rgba(239,68,68,.18)}
    .ok{background:rgba(20,184,166,.14);border-color:rgba(20,184,166,.40)}
    .ok:hover{background:rgba(20,184,166,.20)}
    .chip{
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);color:var(--muted);font-size:12px
    }

    /* TABS */
    .tabs{
      margin-top:12px;
      display:flex;gap:10px;flex-wrap:wrap;
    }
    .tabbtn{
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.03); color:var(--muted);
    }
    .tabbtn.active{
      background:rgba(20,184,166,.14);
      border-color:rgba(20,184,166,.45);
      color:var(--text);
    }

    .grid{display:grid;grid-template-columns: 1.05fr .95fr;gap:14px;margin-top:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--line);border-radius:var(--radius);background:rgba(255,255,255,.03);
      padding:14px;
    }
    .card h2{margin:0 0 10px 0;font-size:14px;color:#dbe2ff}
    .muted{color:var(--muted)}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width: 720px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    .kpi{
      border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.18);
      padding:12px 12px;
    }
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .val{font-size:22px;font-weight:600;margin-top:2px}
    .kpi .hint{font-size:12px;margin-top:4px;color:var(--muted)}
    .kpi.blue .val{color:var(--blue)}
    .kpi.green .val{color:var(--green)}
    .kpi.yellow .val{color:var(--yellow)}
    .kpi.red .val{color:var(--red)}

    .formgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 720px){ .formgrid{grid-template-columns:1fr} }
    .formgrid .full{grid-column:1 / -1}
    .field label{display:block;font-size:12px;color:var(--muted);margin:2px 0 6px}
    .field input,.field select,.field textarea{width:100%}
    textarea{min-height:70px;resize:vertical}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center}

    .tablewrap{overflow:auto;border:1px solid var(--line);border-radius:14px}
    table{width:100%;border-collapse:collapse;min-width:980px}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:top}
    th{position:sticky;top:0;background:#0d1529;font-size:12px;color:var(--muted);text-align:left}
    td{font-size:13px}
    .nowrap{white-space:nowrap}
    .tag{
      font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);
      display:inline-block;background:rgba(255,255,255,.03);color:var(--muted)
    }
    .tag.ok{color:var(--green);border-color:rgba(34,197,94,.35)}
    .tag.no{color:var(--red);border-color:rgba(239,68,68,.35)}
    .tag.wait{color:var(--yellow);border-color:rgba(251,191,36,.35)}
    .small{font-size:12px;color:var(--muted)}
    .hidden{display:none !important}
    .toast{
      position:fixed;right:14px;bottom:14px;
      background:#0f172a;border:1px solid var(--line);border-radius:14px;
      padding:10px 12px;min-width:260px;max-width:520px;
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      z-index:9999;
      white-space:pre-line;
    }
    .toast.err{border-color:rgba(239,68,68,.35)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,monospace}
    .sep{height:1px;background:rgba(255,255,255,.06);margin:10px 0}

    /* Anexos (imagens) */
    .thumbs{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .thumb{
      width:84px;height:84px;border-radius:12px;overflow:hidden;border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      display:grid;place-items:center;
    }
    .thumb img{width:100%;height:100%;object-fit:cover}

    /* Screening Calendar */
    .calTop{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .calTitle{font-weight:600}
    .calGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
      margin-top:10px;
    }
    .dow{
      font-size:12px;color:var(--muted);text-align:center;
      padding:6px 0;
    }
    .dayCell{
      border:1px solid var(--line);
      border-radius:12px;
      min-height:74px;
      padding:8px;
      background:rgba(255,255,255,.02);
      cursor:pointer;
      position:relative;
    }
    .dayNum{font-size:12px;color:var(--muted)}
    .dayCell:hover{border-color:rgba(20,184,166,.55)}
    .dayCell.selected{border:2px solid rgba(20,184,166,.70)}
    .badge{
      position:absolute;right:8px;top:8px;
      font-size:12px;
      padding:2px 8px;border-radius:999px;
      border:1px solid rgba(20,184,166,.45);
      background:rgba(20,184,166,.12);
      color:var(--text);
    }
    .procList{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .procItem{
      border:1px solid var(--line);border-radius:14px;padding:10px;
      background:rgba(0,0,0,.18);
    }
    .procItemTop{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .procName{font-weight:600}
    .procMeta{font-size:12px;color:var(--muted)}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">üß¨</div>
        <div>
          <h1>IEP Recrutamento ‚Äî Online</h1>
          <small>Realtime ‚Ä¢ Firestore ‚Ä¢ Auth ‚Ä¢ Upload de imagens ‚Ä¢ Agenda de Screening</small>
        </div>
      </div>

      <div class="row">
        <span id="roleChip" class="chip">N√£o autenticado</span>
        <input id="emailLogin" type="email" placeholder="email" autocomplete="username" style="width:220px">
        <input id="passwordLogin" type="password" placeholder="senha" autocomplete="current-password" style="width:180px">
        <button id="loginBtn" class="btn">Entrar</button>
        <button id="logoutBtn" class="ghost hidden">Sair</button>
      </div>
    </header>

    <!-- TABS -->
    <div class="tabs">
      <button id="tabBtnRecrutamento" class="tabbtn active">Recrutamento</button>
      <button id="tabBtnScreening" class="tabbtn">Screening</button>
      <span class="chip" id="monthRefChip">M√™s: (auto)</span>
    </div>

    <!-- ========================= -->
    <!-- TAB: RECRUTAMENTO (mantido) -->
    <!-- ========================= -->
    <section id="tabRecrutamento">
      <div class="grid">
        <!-- LEFT -->
        <div class="card">
          <h2>Cadastro / Edi√ß√£o</h2>

          <div class="formgrid">
            <div class="field full">
              <label>Nome / Identificador</label>
              <input id="nome" placeholder="Ex: Iniciais + c√≥digo / nome" />
            </div>

            <div class="field">
              <label>Status</label>
              <select id="status">
                <option value="">Selecione</option>
                <option>Triagem</option>
                <option>Pr√©-screening</option>
                <option>Screening</option>
                <option>Randomizado</option>
                <option>Falha de screening</option>
                <option>Em follow-up</option>
              </select>
            </div>

            <div class="field">
              <label>Estudo</label>
              <input id="estudo" placeholder="Ex: EVOKE-04 / SYMPHONY-1" />
            </div>

            <div class="field">
              <label>Data (refer√™ncia)</label>
              <input id="data" type="date" />
            </div>

            <div class="field">
              <label>Encaminhador</label>
              <select id="encaminhador">
                <option value="">Selecione</option>
                <option>Dr. Milton</option>
                <option>Dr. H√©lio</option>
                <option>Dr. Thiago</option>
                <option>ALTY</option>
                <option>Outro</option>
              </select>
            </div>

            <div class="field full hidden" id="wrapOutroEnc">
              <label>Outro encaminhador</label>
              <input id="outroEncaminhador" placeholder="Digite o encaminhador" />
            </div>

            <div class="field">
              <label>TCLE agendado?</label>
              <select id="tcleAgendado">
                <option>N√£o</option>
                <option>Sim</option>
              </select>
            </div>

            <div class="field">
              <label>TCLE assinado?</label>
              <select id="tcleAssinado">
                <option>N√£o</option>
                <option>Sim</option>
              </select>
            </div>

            <div class="field">
              <label>Eleg√≠vel?</label>
              <select id="elegivel">
                <option>Sim</option>
                <option>N√£o</option>
              </select>
            </div>

            <div class="field">
              <label>Motivo n√£o eleg√≠vel</label>
              <select id="motivoNaoElegivel">
                <option value="">(se aplic√°vel)</option>
                <option>Progress√£o</option>
                <option>Perda de follow-up</option>
                <option>Recusa do paciente</option>
                <option>Outro</option>
              </select>
            </div>

            <div class="field full hidden" id="wrapOutroMotivo">
              <label>Outro motivo</label>
              <input id="outroMotivo" placeholder="Digite o motivo" />
            </div>

            <div class="field full">
              <label>Observa√ß√µes</label>
              <textarea id="obs" placeholder="Notas r√°pidas (sem dados sens√≠veis desnecess√°rios)"></textarea>
            </div>

            <!-- NOVO: Anexar imagens -->
            <div class="field full">
              <label>Anexar imagens (opcional)</label>
              <input id="imagens" type="file" accept="image/*" multiple />
              <div class="small muted">As imagens ser√£o salvas no Firebase Storage e vinculadas ao registro.</div>
              <div id="thumbs" class="thumbs"></div>
            </div>
          </div>

          <div class="actions">
            <button id="saveBtn" class="ok">Salvar</button>
            <button id="cancelBtn" class="ghost hidden">Cancelar edi√ß√£o</button>
            <span class="small" id="accessHint">Fa√ßa login para salvar.</span>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="card">
          <h2>Indicadores (m√™s)</h2>

          <!-- KPIs do m√™s (NOVO) -->
          <div class="kpis">
            <div class="kpi blue">
              <div class="label">Encaminhados do m√™s</div>
              <div id="kpiMesEnc" class="val">0</div>
              <div class="hint">baseado na data do registro</div>
            </div>
            <div class="kpi green">
              <div class="label">Em Screening</div>
              <div id="kpiMesScreening" class="val">0</div>
              <div class="hint">status = Screening</div>
            </div>
            <div class="kpi red">
              <div class="label">Falhas de Screening</div>
              <div id="kpiMesFalha" class="val">0</div>
              <div class="hint">status = Falha de screening</div>
            </div>
            <div class="kpi yellow">
              <div class="label">TCLE assinado (m√™s)</div>
              <div id="kpiMesTCLE" class="val">0</div>
              <div class="hint">tcleAssinado = Sim</div>
            </div>
          </div>

          <div style="margin-top:12px" class="formgrid">
            <div class="field">
              <label>Busca</label>
              <input id="search" placeholder="nome / status / estudo / encaminhador" />
            </div>
            <div class="field">
              <label>M√™s</label>
              <input id="monthFilter" type="month" />
            </div>
            <div class="field">
              <label>Status</label>
              <select id="statusFilter">
                <option value="">Todos</option>
                <option>Triagem</option>
                <option>Pr√©-screening</option>
                <option>Screening</option>
                <option>Randomizado</option>
                <option>Falha de screening</option>
                <option>Em follow-up</option>
              </select>
            </div>
            <div class="field">
              <label>A√ß√µes</label>
              <div class="row">
                <button id="clearMonthBtn" class="ghost">Limpar m√™s</button>
                <button id="exportBtn" class="ghost">Exportar CSV</button>
                <button id="exportPdfBtn" class="btn">Baixar PDF (resumo)</button>
              </div>
            </div>
          </div>

          <div class="sep"></div>

          <!-- NOVO: Quem encaminhou -->
          <h2>Quem encaminhou (m√™s)</h2>
          <div id="referralBox" class="small muted">Sem dados.</div>

          <div class="sep"></div>

          <h2>Status (gr√°fico)</h2>
          <canvas id="statusChart" height="150"></canvas>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <h2>Pacientes</h2>
        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Status</th>
                <th>Estudo</th>
                <th>Encaminhador</th>
                <th>Eleg√≠vel</th>
                <th>Motivo</th>
                <th>Data</th>
                <th>TCLE</th>
                <th class="nowrap">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
        <div id="emptyMsg" class="small muted" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- ========================= -->
    <!-- TAB: SCREENING (NOVO) -->
    <!-- ========================= -->
    <section id="tabScreening" class="hidden">
      <div class="grid">
        <div class="card">
          <h2>Calend√°rio ‚Äî Screening</h2>

          <div class="calTop">
            <div class="row">
              <button id="calPrev" class="ghost">‚óÄ</button>
              <div class="calTitle" id="calTitle">‚Äî</div>
              <button id="calNext" class="ghost">‚ñ∂</button>
            </div>
            <div class="row">
              <button id="calToday" class="btn">Hoje</button>
              <span class="chip" id="selDateChip">Data: ‚Äî</span>
            </div>
          </div>

          <div class="calGrid" id="calDows"></div>
          <div class="calGrid" id="calDays"></div>

          <div class="sep"></div>

          <h2>Procedimentos do dia</h2>
          <div id="procList" class="procList"></div>
          <div id="procEmpty" class="small muted"></div>
        </div>

        <div class="card">
          <h2>Novo procedimento</h2>
          <div class="small muted">Selecione um dia no calend√°rio e registre o procedimento (pode repetir paciente no m√™s).</div>

          <div class="formgrid" style="margin-top:10px">
            <div class="field full">
              <label>Paciente (cadastros existentes)</label>
              <select id="procPatientSelect">
                <option value="">Selecione‚Ä¶</option>
              </select>
              <div class="small muted" style="margin-top:6px">Se quiser registrar com nome diferente do cadastro, preencha abaixo.</div>
            </div>

            <div class="field full">
              <label>Nome exibido (opcional)</label>
              <input id="procPatientName" placeholder="Deixe vazio para usar o selecionado" />
            </div>

            <div class="field">
              <label>Tipo</label>
              <select id="procType">
                <option value="Envio para central">Envio para central</option>
                <option value="Coleta local">Coleta local</option>
                <option value="Consulta/Visita">Consulta/Visita</option>
                <option value="TC de t√≥rax">TC de t√≥rax</option>
                <option value="PET-CT">PET-CT</option>
                <option value="Bi√≥psia">Bi√≥psia</option>
                <option value="Medula">Medula</option>
                <option value="Laborat√≥rio">Laborat√≥rio</option>
                <option value="Outro">Outro</option>
              </select>
            </div>

            <div class="field">
              <label>Hora (opcional)</label>
              <input id="procTime" type="time" />
            </div>

            <div class="field full">
              <label>Descri√ß√£o</label>
              <textarea id="procDesc" placeholder="Ex: Coletar hemograma pr√© dose / enviar bloco para central..."></textarea>
            </div>
          </div>

          <div class="actions">
            <button id="procSaveBtn" class="ok">Salvar procedimento</button>
            <button id="procNotifyBtn" class="btn">Ativar notifica√ß√µes</button>
            <span class="small muted">Notifica ‚Äúamanh√£‚Äù enquanto o site estiver aberto.</span>
          </div>

          <div class="sep"></div>
          <div class="small muted" id="notifyStatus">Notifica√ß√µes: n√£o ativadas</div>
        </div>
      </div>
    </section>
  </div>

  <div id="toast" class="toast hidden"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, doc, setDoc, deleteDoc, getDoc,
    onSnapshot, query, orderBy, serverTimestamp, where, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getStorage, ref as sRef, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  // ======= firebaseConfig (SEU) =======
  const firebaseConfig = {
    apiKey: "AIzaSyCvoVAWsVMYfAQv-pISsn7mNfdInIjLDFo",
    authDomain: "iep-recrutamento.firebaseapp.com",
    projectId: "iep-recrutamento",
    storageBucket: "iep-recrutamento.firebasestorage.app",
    messagingSenderId: "297731374831",
    appId: "1:297731374831:web:684eed6683602d6c3fe51a",
    measurementId: "G-8ST5S7FWE0"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

  // ======= Estado =======
  let DB = [];
  let CHART = null;
  let editId = null;

  let CURRENT_USER = null;
  let CURRENT_ROLE = null;   // "admin" | "assistant"
  let IS_ACTIVE = false;

  // Screening procedures
  let PROC = []; // cache mensal p/ badges
  let calView = new Date(); // m√™s exibido
  let selectedDate = null;  // yyyy-mm-dd
  let notifyEnabled = false;

  // ======= Helpers =======
  const $ = (id) => document.getElementById(id);
  const esc = (s) => (s ?? "").toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  const uid = () => "p_" + Date.now().toString(36) + Math.random().toString(36).slice(2,8);

  function toast(msg, err=false){
    const t = $("toast");
    t.textContent = msg;
    t.classList.remove("hidden");
    t.classList.toggle("err", !!err);
    setTimeout(()=>t.classList.add("hidden"), 3200);
  }

  function fmtMonthLabel(d){
    const m = d.toLocaleString("pt-BR", {month:"long"});
    return `${m.charAt(0).toUpperCase()+m.slice(1)} ${d.getFullYear()}`;
  }

  function ymd(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }

  function parseMonth(v){
    if(!v) return null;
    const [y,m] = v.split("-").map(Number);
    return {y,m};
  }
  function inMonth(dateStr, sel){
    if(!sel) return true;
    if(!dateStr) return false;
    const d = new Date(dateStr + "T00:00:00");
    return d.getFullYear()===sel.y && (d.getMonth()+1)===sel.m;
  }
  function currentMonthObj(){
    const now = new Date();
    return {y: now.getFullYear(), m: now.getMonth()+1};
  }
  function monthKey(sel){
    return `${sel.y}-${String(sel.m).padStart(2,"0")}`;
  }

  // ======= Tabs =======
  function setTab(tab){
    const isRec = (tab === "recrutamento");
    $("tabRecrutamento").classList.toggle("hidden", !isRec);
    $("tabScreening").classList.toggle("hidden", isRec);
    $("tabBtnRecrutamento").classList.toggle("active", isRec);
    $("tabBtnScreening").classList.toggle("active", !isRec);
  }
  $("tabBtnRecrutamento").addEventListener("click", ()=>setTab("recrutamento"));
  $("tabBtnScreening").addEventListener("click", ()=>setTab("screening"));

  // ======= UI toggles (mantidos) =======
  function toggleOutroEnc(){
    const v = $("encaminhador").value;
    $("wrapOutroEnc").classList.toggle("hidden", v !== "Outro");
    if(v !== "Outro") $("outroEncaminhador").value = "";
  }
  function toggleOutroMotivo(){
    const v = $("motivoNaoElegivel").value;
    $("wrapOutroMotivo").classList.toggle("hidden", v !== "Outro");
    if(v !== "Outro") $("outroMotivo").value = "";
  }
  $("encaminhador").addEventListener("change", toggleOutroEnc);
  $("motivoNaoElegivel").addEventListener("change", toggleOutroMotivo);
  $("elegivel").addEventListener("change", () => {
    const isNo = $("elegivel").value === "N√£o";
    $("motivoNaoElegivel").disabled = !isNo;
    $("outroMotivo").disabled = !isNo;
    if(!isNo){
      $("motivoNaoElegivel").value = "";
      $("outroMotivo").value = "";
      toggleOutroMotivo();
    }
  });

  // ======= Preview thumbs (novo) =======
  function renderLocalThumbs(files){
    const box = $("thumbs");
    box.innerHTML = "";
    if(!files || !files.length) return;
    Array.from(files).slice(0,10).forEach(f=>{
      const div = document.createElement("div");
      div.className = "thumb";
      const img = document.createElement("img");
      img.alt = "img";
      img.src = URL.createObjectURL(f);
      div.appendChild(img);
      box.appendChild(div);
    });
  }
  $("imagens").addEventListener("change", (e)=>{
    renderLocalThumbs(e.target.files);
  });

  // ======= Auth =======
  async function login(){
    const email = $("emailLogin").value.trim();
    const pass = $("passwordLogin").value;
    if(!email || !pass) return toast("Informe email e senha", true);

    try{
      await signInWithEmailAndPassword(auth, email, pass);
    }catch(e){
      toast("Erro no login: " + (e?.message || e), true);
    }
  }
  async function logout(){
    await signOut(auth);
  }
  $("loginBtn").addEventListener("click", login);
  $("logoutBtn").addEventListener("click", logout);

  function setAuthUI(logged){
    $("logoutBtn").classList.toggle("hidden", !logged);
    $("loginBtn").classList.toggle("hidden", logged);
    $("emailLogin").disabled = logged;
    $("passwordLogin").disabled = logged;
  }

  async function getRole(uid){
    const snap = await getDoc(doc(db,"users",uid));
    if(!snap.exists()) return {active:false, role:null};
    const data = snap.data() || {};
    return { active: !!data.active, role: data.role || null };
  }

  // ======= Firestore realtime (patients) =======
  function startRealtimePatients(){
    const q = query(collection(db, "patients"), orderBy("data","desc"));
    return onSnapshot(q, (snap)=>{
      DB = snap.docs.map(d => d.data());
      refreshUI();
      refreshPatientSelect();
    }, (err)=>{
      console.error(err);
      toast("Erro ao sincronizar Firestore (patients)", true);
    });
  }

  // ======= Firestore realtime (procedures) =======
  function monthRange(sel){
    const start = new Date(sel.y, sel.m-1, 1);
    const end = new Date(sel.y, sel.m, 1); // next month
    return { start: ymd(start), end: ymd(end) };
  }

  function startRealtimeProcedures(sel){
    const {start, end} = monthRange(sel);
    const q = query(
      collection(db, "procedures"),
      where("date", ">=", start),
      where("date", "<", end),
      orderBy("date","asc")
    );
    return onSnapshot(q, (snap)=>{
      PROC = snap.docs.map(d => d.data());
      renderCalendar();
      renderProceduresOfSelectedDay();
      checkTomorrowNotifications(); // re-avalia
    }, (err)=>{
      console.error(err);
      toast("Erro ao sincronizar Firestore (procedures)", true);
    });
  }

  let unsubPatients = null;
  let unsubProcedures = null;

  onAuthStateChanged(auth, async (user)=>{
    CURRENT_USER = user || null;

    if(unsubPatients){ unsubPatients(); unsubPatients=null; }
    if(unsubProcedures){ unsubProcedures(); unsubProcedures=null; }

    if(!user){
      setAuthUI(false);
      CURRENT_ROLE = null; IS_ACTIVE = false;
      $("roleChip").textContent = "N√£o autenticado";
      $("accessHint").textContent = "Fa√ßa login para salvar.";
      DB = [];
      PROC = [];
      refreshUI();
      refreshPatientSelect();
      renderCalendar();
      return;
    }

    setAuthUI(true);

    const info = await getRole(user.uid);
    CURRENT_ROLE = info.role;
    IS_ACTIVE = info.active;

    if(!IS_ACTIVE){
      $("roleChip").textContent = "Aguardando libera√ß√£o";
      $("accessHint").textContent = "Seu acesso n√£o est√° ativo (admin precisa liberar).";
      DB = [];
      PROC = [];
      refreshUI();
      refreshPatientSelect();
      renderCalendar();
      toast("Acesso n√£o liberado ainda.", true);
      return;
    }

    $("roleChip").textContent = `${user.email} ‚Ä¢ ${CURRENT_ROLE || "sem role"}`;
    $("accessHint").textContent = (CURRENT_ROLE === "admin")
      ? "Admin: pode criar/editar/excluir"
      : "Assistente: pode criar/editar (n√£o exclui)";

    // Start realtime
    unsubPatients = startRealtimePatients();

    // Procedures realtime for current calendar month
    const sel = {y: calView.getFullYear(), m: calView.getMonth()+1};
    unsubProcedures = startRealtimeProcedures(sel);

    toast("Conectado (online)!");
  });

  // ======= Form (patients) =======
  function validate(){
    const req = ["nome","status","estudo","data"];
    for(const id of req){
      if(!$(id).value.trim()){
        toast("Preencha Nome, Status, Estudo e Data", true);
        return false;
      }
    }
    return true;
  }

  function buildRec(){
    const enc = ($("encaminhador").value === "Outro")
      ? ($("outroEncaminhador").value.trim() || "Outro")
      : $("encaminhador").value;

    const isNo = $("elegivel").value === "N√£o";
    const motivo = isNo
      ? (($("motivoNaoElegivel").value === "Outro")
          ? ($("outroMotivo").value.trim() || "Outro")
          : $("motivoNaoElegivel").value)
      : "";

    return {
      id: editId || uid(),
      nome: $("nome").value.trim(),
      status: $("status").value.trim(),
      estudo: $("estudo").value.trim(),
      data: $("data").value,
      encaminhador: enc || "",
      tcleAgendado: $("tcleAgendado").value,
      tcleAssinado: $("tcleAssinado").value,
      elegivel: $("elegivel").value,
      motivoNaoElegivel: motivo || "",
      obs: $("obs").value.trim()
    };
  }

  async function uploadImagesForPatient(patientId){
    const files = $("imagens").files;
    if(!files || !files.length) return [];

    const urls = [];
    for(const f of Array.from(files)){
      const safeName = (f.name || "img").replaceAll(" ", "_");
      const path = `patients/${patientId}/${Date.now()}_${safeName}`;
      const r = sRef(storage, path);
      const buf = await f.arrayBuffer();
      await uploadBytes(r, new Uint8Array(buf), { contentType: f.type || "image/jpeg" });
      const url = await getDownloadURL(r);
      urls.push({ url, name: f.name || "imagem", createdAt: Date.now() });
    }
    return urls;
  }

  async function save(){
    if(!CURRENT_USER || !IS_ACTIVE) return toast("Sem acesso. Fa√ßa login.", true);
    if(!validate()) return;

    const rec = buildRec();

    try{
      // Upload imagens (se houver) e mesclar sem apagar as antigas
      const newImgs = await uploadImagesForPatient(rec.id);

      // Buscar doc atual para manter imagens existentes
      const currentSnap = await getDoc(doc(db,"patients",rec.id));
      const currentImgs = currentSnap.exists() ? (currentSnap.data()?.images || []) : [];

      await setDoc(doc(db,"patients",rec.id), {
        ...rec,
        images: [...currentImgs, ...newImgs],
        updatedAt: serverTimestamp(),
        updatedBy: CURRENT_USER.uid
      }, {merge:true});

      resetForm();
      toast("Salvo!");
    }catch(e){
      console.error(e);
      toast("Falha ao salvar: " + (e?.message||e), true);
    }
  }

  function resetForm(){
    editId = null;
    $("nome").value = "";
    $("status").value = "";
    $("estudo").value = "";
    $("data").value = "";
    $("encaminhador").value = "";
    $("outroEncaminhador").value = "";
    $("tcleAgendado").value = "N√£o";
    $("tcleAssinado").value = "N√£o";
    $("elegivel").value = "Sim";
    $("motivoNaoElegivel").value = "";
    $("outroMotivo").value = "";
    $("obs").value = "";
    $("imagens").value = "";
    $("thumbs").innerHTML = "";
    toggleOutroEnc();
    toggleOutroMotivo();
    $("cancelBtn").classList.add("hidden");
  }

  function renderExistingImages(images){
    const box = $("thumbs");
    box.innerHTML = "";
    if(!images || !images.length) return;
    images.slice().reverse().slice(0,12).forEach(img=>{
      const div = document.createElement("a");
      div.className = "thumb";
      div.href = img.url;
      div.target = "_blank";
      const im = document.createElement("img");
      im.alt = img.name || "imagem";
      im.src = img.url;
      div.appendChild(im);
      box.appendChild(div);
    });
  }

  function fillForm(p){
    editId = p.id;
    $("nome").value = p.nome || "";
    $("status").value = p.status || "";
    $("estudo").value = p.estudo || "";
    $("data").value = p.data || "";
    $("tcleAgendado").value = p.tcleAgendado || "N√£o";
    $("tcleAssinado").value = p.tcleAssinado || "N√£o";
    $("elegivel").value = p.elegivel || "Sim";
    $("obs").value = p.obs || "";
    $("imagens").value = ""; // n√£o carrega arquivos por seguran√ßa

    const knownEnc = ["Dr. Milton","Dr. H√©lio","Dr. Thiago","ALTY"];
    if(p.encaminhador && knownEnc.includes(p.encaminhador)){
      $("encaminhador").value = p.encaminhador;
      $("outroEncaminhador").value = "";
    } else if(p.encaminhador){
      $("encaminhador").value = "Outro";
      $("outroEncaminhador").value = p.encaminhador;
    } else {
      $("encaminhador").value = "";
      $("outroEncaminhador").value = "";
    }
    toggleOutroEnc();

    const isNo = (p.elegivel === "N√£o");
    $("motivoNaoElegivel").disabled = !isNo;
    $("outroMotivo").disabled = !isNo;

    const knownMot = ["Progress√£o","Perda de follow-up","Recusa do paciente","Outro"];
    if(isNo){
      if(p.motivoNaoElegivel && knownMot.includes(p.motivoNaoElegivel)){
        $("motivoNaoElegivel").value = p.motivoNaoElegivel;
        $("outroMotivo").value = "";
      } else if(p.motivoNaoElegivel){
        $("motivoNaoElegivel").value = "Outro";
        $("outroMotivo").value = p.motivoNaoElegivel;
      } else {
        $("motivoNaoElegivel").value = "";
        $("outroMotivo").value = "";
      }
    } else {
      $("motivoNaoElegivel").value = "";
      $("outroMotivo").value = "";
    }
    toggleOutroMotivo();

    renderExistingImages(p.images || []);

    $("cancelBtn").classList.remove("hidden");
  }

  async function remove(id){
    if(!CURRENT_USER || !IS_ACTIVE) return toast("Sem acesso.", true);
    if(CURRENT_ROLE !== "admin") return toast("Assistente n√£o pode excluir.", true);
    if(!confirm("Excluir este registro?")) return;

    try{
      await deleteDoc(doc(db,"patients",id));
      toast("Exclu√≠do.");
    }catch(e){
      toast("Falha ao excluir: " + (e?.message||e), true);
    }
  }

  $("saveBtn").addEventListener("click", save);
  $("cancelBtn").addEventListener("click", () => { resetForm(); toast("Edi√ß√£o cancelada"); });

  // ======= Dataset / filtros =======
  function dataset(){
    const q = ($("search").value || "").toLowerCase();
    const selMonth = parseMonth($("monthFilter").value);
    const st = ($("statusFilter").value || "").toLowerCase();

    return DB
      .filter(p=>{
        const hitQ = !q
          || (p.nome||"").toLowerCase().includes(q)
          || (p.status||"").toLowerCase().includes(q)
          || (p.estudo||"").toLowerCase().includes(q)
          || (p.encaminhador||"").toLowerCase().includes(q);

        const hitM = inMonth(p.data, selMonth);
        const hitS = !st || (p.status||"").toLowerCase()===st;

        return hitQ && hitM && hitS;
      })
      .sort((a,b)=> (b.data||"").localeCompare(a.data||""));
  }

  function monthDataset(){
    // KPIs e ranking sempre pelo "m√™s de refer√™ncia":
    // - se o monthFilter estiver preenchido -> usa ele
    // - sen√£o -> usa m√™s atual
    const sel = parseMonth($("monthFilter").value) || currentMonthObj();
    $("monthRefChip").textContent = `M√™s: ${monthKey(sel)}`;
    return DB.filter(p => inMonth(p.data, sel));
  }

  function updateMonthKPIs(){
    const list = monthDataset();
    const enc = list.length;
    const inScr = list.filter(x => (x.status||"") === "Screening").length;
    const fail = list.filter(x => (x.status||"") === "Falha de screening").length;
    const tcle = list.filter(x => (x.tcleAssinado||"") === "Sim").length;

    $("kpiMesEnc").textContent = enc;
    $("kpiMesScreening").textContent = inScr;
    $("kpiMesFalha").textContent = fail;
    $("kpiMesTCLE").textContent = tcle;

    // ranking de encaminhadores
    const counts = {};
    for(const p of list){
      const k = (p.encaminhador || "N√£o informado").trim() || "N√£o informado";
      counts[k] = (counts[k] || 0) + 1;
    }
    const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
    if(!sorted.length){
      $("referralBox").textContent = "Sem dados no m√™s.";
    }else{
      $("referralBox").innerHTML =
        sorted.map(([k,v],i)=> `${i+1}. <b>${esc(k)}</b> ‚Äî ${v}`).join("<br>");
    }
  }

  function renderTable(){
    const tbody = $("tableBody");
    const list = dataset();
    tbody.innerHTML = "";

    for(const r of list){
      const tagElig = (r.elegivel==="Sim") ? `<span class="tag ok">Sim</span>` : `<span class="tag no">N√£o</span>`;
      const tagTCLE = (r.tcleAssinado==="Sim") ? `<span class="tag ok">Sim</span>` : `<span class="tag">N√£o</span>`;

      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>
            <div>${esc(r.nome)}</div>
            ${r.obs ? `<div class="small">${esc(r.obs)}</div>` : ``}
            ${(r.images && r.images.length) ? `<div class="small muted">üìé ${r.images.length} imagem(ns)</div>` : ``}
          </td>
          <td>${esc(r.status)}</td>
          <td>${esc(r.estudo)}</td>
          <td>${esc(r.encaminhador)}</td>
          <td>${tagElig}</td>
          <td>${esc(r.motivoNaoElegivel || "-")}</td>
          <td class="nowrap">${esc(r.data)}</td>
          <td>${tagTCLE}</td>
          <td class="nowrap">
            <button class="btn" data-edit="${esc(r.id)}">‚úèÔ∏è</button>
            <button class="danger" data-del="${esc(r.id)}">üóëÔ∏è</button>
          </td>
        </tr>
      `);
    }

    $("emptyMsg").textContent = list.length ? "" : "Sem registros para esta vis√£o.";
    updateChart(list);

    // bind buttons
    document.querySelectorAll("[data-edit]").forEach(b=>{
      b.onclick = () => {
        const id = b.getAttribute("data-edit");
        const p = DB.find(x=>x.id===id);
        if(p) fillForm(p);
      };
    });
    document.querySelectorAll("[data-del]").forEach(b=>{
      b.onclick = () => remove(b.getAttribute("data-del"));
    });
  }

  function updateChart(list){
    const counts = {};
    for(const p of list){
      const k = p.status || "Sem status";
      counts[k] = (counts[k]||0)+1;
    }
    const labels = Object.keys(counts);
    const data = Object.values(counts);

    const ctx = $("statusChart").getContext("2d");
    if(CHART) CHART.destroy();
    CHART = new Chart(ctx, {
      type:"pie",
      data:{ labels, datasets:[{ data }] }
    });
  }

  function refreshUI(){
    updateMonthKPIs();
    renderTable();
  }

  ["search","monthFilter","statusFilter"].forEach(id=>{
    $(id).addEventListener("input", refreshUI);
    $(id).addEventListener("change", refreshUI);
  });

  $("clearMonthBtn").addEventListener("click", ()=>{
    $("monthFilter").value = "";
    refreshUI();
  });

  // ======= CSV Export (mantido) =======
  $("exportBtn").addEventListener("click", ()=>{
    const rows = dataset();
    const header = ["id","nome","status","estudo","data","encaminhador","tcleAgendado","tcleAssinado","elegivel","motivoNaoElegivel","obs","updatedBy"];
    const csv = [
      header.join(","),
      ...rows.map(r => header.map(h => `"${String(r[h] ?? "").replaceAll('"','""')}"`).join(","))
    ].join("\n");

    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "iep_recrutamento_export.csv";
    a.click();
    URL.revokeObjectURL(url);
  });

  // ======= PDF Export (NOVO: somente nomes e n√∫meros) =======
  $("exportPdfBtn").addEventListener("click", ()=>{
    const sel = parseMonth($("monthFilter").value) || currentMonthObj();
    const list = DB.filter(p => inMonth(p.data, sel));

    const total = list.length;
    const inScr = list.filter(x => (x.status||"") === "Screening").length;
    const fail = list.filter(x => (x.status||"") === "Falha de screening").length;
    const tcle = list.filter(x => (x.tcleAssinado||"") === "Sim").length;

    const counts = {};
    for(const p of list){
      const k = (p.encaminhador || "N√£o informado").trim() || "N√£o informado";
      counts[k] = (counts[k] || 0) + 1;
    }
    const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]);

    const { jsPDF } = window.jspdf;
    const docp = new jsPDF({ unit:"pt", format:"a4" });

    let y = 54;
    docp.setFont("helvetica","bold");
    docp.setFontSize(16);
    docp.text("IEP Recrutamento ‚Äî Resumo (M√™s)", 40, y); y += 18;

    docp.setFont("helvetica","normal");
    docp.setFontSize(11);
    docp.text(`M√™s de refer√™ncia: ${monthKey(sel)}`, 40, y); y += 18;

    docp.setDrawColor(120);
    docp.line(40, y, 555, y); y += 18;

    docp.setFont("helvetica","bold");
    docp.text("Indicadores", 40, y); y += 14;

    docp.setFont("helvetica","normal");
    docp.text(`Encaminhados do m√™s: ${total}`, 40, y); y += 14;
    docp.text(`Em Screening: ${inScr}`, 40, y); y += 14;
    docp.text(`Falhas de Screening: ${fail}`, 40, y); y += 14;
    docp.text(`TCLE assinado: ${tcle}`, 40, y); y += 18;

    docp.setFont("helvetica","bold");
    docp.text("Quem encaminhou (quantidade)", 40, y); y += 14;
    docp.setFont("helvetica","normal");

    if(!sorted.length){
      docp.text("Sem dados.", 40, y); y += 14;
    } else {
      for(const [k,v] of sorted){
        const line = `${k}: ${v}`;
        docp.text(line, 40, y); y += 14;
        if(y > 780){
          docp.addPage();
          y = 54;
        }
      }
    }

    docp.save(`IEP_Resumo_${monthKey(sel)}.pdf`);
  });

  // ======= Screening: dropdown de pacientes =======
  function refreshPatientSelect(){
    const sel = $("procPatientSelect");
    const current = sel.value;
    sel.innerHTML = `<option value="">Selecione‚Ä¶</option>`;
    const items = [...DB].sort((a,b)=>(a.nome||"").localeCompare(b.nome||""));
    for(const p of items){
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.nome || p.id;
      sel.appendChild(opt);
    }
    // tenta manter sele√ß√£o
    if(current) sel.value = current;
  }

  // ======= Screening: calend√°rio =======
  const DOWS = ["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"];

  function renderCalendar(){
    $("calTitle").textContent = fmtMonthLabel(calView);

    // DOW headers
    const dows = $("calDows");
    dows.innerHTML = "";
    for(const d of DOWS){
      const div = document.createElement("div");
      div.className = "dow";
      div.textContent = d;
      dows.appendChild(div);
    }

    // days
    const daysBox = $("calDays");
    daysBox.innerHTML = "";

    const y = calView.getFullYear();
    const m = calView.getMonth(); // 0-based
    const first = new Date(y, m, 1);
    const firstDow = first.getDay();
    const last = new Date(y, m+1, 0);
    const daysInMonth = last.getDate();

    // badges por dia
    const badgeCount = {};
    for(const pr of PROC){
      badgeCount[pr.date] = (badgeCount[pr.date]||0) + 1;
    }

    // empty cells before
    for(let i=0;i<firstDow;i++){
      const empty = document.createElement("div");
      empty.style.opacity = "0";
      daysBox.appendChild(empty);
    }

    for(let d=1; d<=daysInMonth; d++){
      const cell = document.createElement("div");
      cell.className = "dayCell";
      const date = new Date(y, m, d);
      const dateStr = ymd(date);

      if(selectedDate === dateStr) cell.classList.add("selected");

      const num = document.createElement("div");
      num.className = "dayNum";
      num.textContent = d;
      cell.appendChild(num);

      const c = badgeCount[dateStr] || 0;
      if(c){
        const b = document.createElement("div");
        b.className = "badge";
        b.textContent = c;
        cell.appendChild(b);
      }

      cell.addEventListener("click", ()=>{
        selectedDate = dateStr;
        $("selDateChip").textContent = `Data: ${selectedDate}`;
        renderCalendar();
        renderProceduresOfSelectedDay();
      });

      daysBox.appendChild(cell);
    }

    if(!selectedDate){
      const today = new Date();
      if(today.getFullYear()===y && today.getMonth()===m){
        selectedDate = ymd(today);
        $("selDateChip").textContent = `Data: ${selectedDate}`;
      } else {
        selectedDate = ymd(new Date(y,m,1));
        $("selDateChip").textContent = `Data: ${selectedDate}`;
      }
    }
  }

  $("calPrev").addEventListener("click", ()=>{
    calView = new Date(calView.getFullYear(), calView.getMonth()-1, 1);
    const sel = {y: calView.getFullYear(), m: calView.getMonth()+1};
    if(unsubProcedures){ unsubProcedures(); }
    if(CURRENT_USER && IS_ACTIVE){
      unsubProcedures = startRealtimeProcedures(sel);
    } else {
      PROC = [];
      renderCalendar();
      renderProceduresOfSelectedDay();
    }
  });

  $("calNext").addEventListener("click", ()=>{
    calView = new Date(calView.getFullYear(), calView.getMonth()+1, 1);
    const sel = {y: calView.getFullYear(), m: calView.getMonth()+1};
    if(unsubProcedures){ unsubProcedures(); }
    if(CURRENT_USER && IS_ACTIVE){
      unsubProcedures = startRealtimeProcedures(sel);
    } else {
      PROC = [];
      renderCalendar();
      renderProceduresOfSelectedDay();
    }
  });

  $("calToday").addEventListener("click", ()=>{
    calView = new Date();
    selectedDate = ymd(new Date());
    $("selDateChip").textContent = `Data: ${selectedDate}`;
    const sel = {y: calView.getFullYear(), m: calView.getMonth()+1};
    if(unsubProcedures){ unsubProcedures(); }
    if(CURRENT_USER && IS_ACTIVE){
      unsubProcedures = startRealtimeProcedures(sel);
    } else {
      PROC = [];
      renderCalendar();
      renderProceduresOfSelectedDay();
    }
  });

  // ======= Screening: salvar procedimento =======
  function procId(){ return "sc_" + Date.now().toString(36) + Math.random().toString(36).slice(2,8); }

  async function saveProcedure(){
    if(!CURRENT_USER || !IS_ACTIVE) return toast("Sem acesso. Fa√ßa login.", true);
    if(!selectedDate) return toast("Selecione uma data no calend√°rio.", true);

    const pid = $("procPatientSelect").value;
    const customName = $("procPatientName").value.trim();

    let patientName = customName;
    if(!patientName){
      const p = DB.find(x=>x.id===pid);
      patientName = p?.nome || "";
    }
    if(!patientName) return toast("Selecione um paciente ou informe o nome.", true);

    const type = $("procType").value;
    const time = $("procTime").value || "";
    const desc = $("procDesc").value.trim();

    const rec = {
      id: procId(),
      date: selectedDate,
      time,
      type,
      desc,
      patientId: pid || "",
      patientName,
      createdAt: Date.now(),
      createdBy: CURRENT_USER.uid,
      updatedAt: serverTimestamp()
    };

    try{
      await setDoc(doc(db,"procedures",rec.id), rec, {merge:true});
      $("procPatientName").value = "";
      $("procTime").value = "";
      $("procDesc").value = "";
      toast("Procedimento salvo!");
    }catch(e){
      console.error(e);
      toast("Erro ao salvar procedimento: " + (e?.message||e), true);
    }
  }

  async function deleteProcedure(id){
    if(!CURRENT_USER || !IS_ACTIVE) return toast("Sem acesso.", true);
    if(CURRENT_ROLE !== "admin") return toast("Assistente n√£o pode excluir procedimento.", true);
    if(!confirm("Excluir este procedimento?")) return;
    try{
      await deleteDoc(doc(db,"procedures",id));
      toast("Procedimento exclu√≠do.");
    }catch(e){
      toast("Erro ao excluir: " + (e?.message||e), true);
    }
  }

  $("procSaveBtn").addEventListener("click", saveProcedure);

  // ======= Screening: listar procedimentos do dia =======
  function renderProceduresOfSelectedDay(){
    const box = $("procList");
    box.innerHTML = "";
    const list = PROC.filter(p => p.date === selectedDate)
                     .sort((a,b)=> (a.time||"").localeCompare(b.time||""));

    if(!list.length){
      $("procEmpty").textContent = "Nenhum procedimento neste dia.";
      return;
    }
    $("procEmpty").textContent = "";

    for(const p of list){
      const div = document.createElement("div");
      div.className = "procItem";
      div.innerHTML = `
        <div class="procItemTop">
          <div>
            <div class="procName">${esc(p.patientName || "Paciente")}</div>
            <div class="procMeta">${esc(p.type)} ${p.time ? "‚Ä¢ " + esc(p.time) : ""}</div>
            ${p.desc ? `<div class="small">${esc(p.desc)}</div>` : ``}
          </div>
          <div>
            <button class="danger" data-proc-del="${esc(p.id)}">üóëÔ∏è</button>
          </div>
        </div>
      `;
      box.appendChild(div);
    }

    document.querySelectorAll("[data-proc-del]").forEach(btn=>{
      btn.onclick = ()=> deleteProcedure(btn.getAttribute("data-proc-del"));
    });
  }

  // ======= Notifica√ß√µes (1 dia antes - enquanto aberto) =======
  async function enableNotifications(){
    if(!("Notification" in window)){
      toast("Seu navegador n√£o suporta notifica√ß√µes.", true);
      return;
    }
    const perm = await Notification.requestPermission();
    notifyEnabled = (perm === "granted");
    $("notifyStatus").textContent = notifyEnabled ? "Notifica√ß√µes: ativadas ‚úÖ" : "Notifica√ß√µes: n√£o permitidas ‚ùå";
    if(notifyEnabled){
      toast("Notifica√ß√µes ativadas!");
      checkTomorrowNotifications(true);
    }
  }
  $("procNotifyBtn").addEventListener("click", enableNotifications);

  function showBrowserNotification(title, body){
    try{
      if(!notifyEnabled) return;
      new Notification(title, { body });
    }catch(_){}
  }

  function tomorrowStr(){
    const d = new Date();
    d.setDate(d.getDate()+1);
    return ymd(d);
  }

  // evita spam: s√≥ notifica 1x por dia
  function notifKey(dateStr){
    return `iep_notified_${dateStr}`;
  }

  function checkTomorrowNotifications(force=false){
    const tmr = tomorrowStr();
    const list = PROC.filter(p => p.date === tmr);
    if(!list.length) return;

    const already = localStorage.getItem(notifKey(tmr));
    if(already && !force) return;

    const msgLines = list
      .slice(0,10)
      .map(p=> `‚Ä¢ ${p.patientName}${p.time ? " ("+p.time+")" : ""} ‚Äî ${p.type}`)
      .join("\n");

    // toast sempre
    toast(`üîî Procedimentos amanh√£ (${tmr}):\n${msgLines}`, false);

    // notification se ativado
    if(notifyEnabled){
      showBrowserNotification("Procedimentos amanh√£", `${tmr}\n${msgLines}`);
    }

    localStorage.setItem(notifKey(tmr), "1");
  }

  // checa 1x ao carregar e a cada 10 minutos (enquanto aberto)
  setInterval(()=>checkTomorrowNotifications(false), 10*60*1000);

  // ======= Init =======
  toggleOutroEnc();
  toggleOutroMotivo();
  $("motivoNaoElegivel").disabled = true;
  $("outroMotivo").disabled = true;

  // month ref chip default
  $("monthRefChip").textContent = `M√™s: ${monthKey(currentMonthObj())}`;
  $("selDateChip").textContent = "Data: ‚Äî";

  // render inicial
  refreshUI();
  renderCalendar();
  renderProceduresOfSelectedDay();

  // se usu√°rio mudar monthFilter, atualiza chip e KPIs
  $("monthFilter").addEventListener("change", ()=>{
    refreshUI();
  });

</script>
</body>
</html>

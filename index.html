<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IEP Recrutamento ‚Äî Online</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b0c10;
      --panel:#11131a;
      --panel2:#0f1117;
      --line:#24283a;
      --text:#e7e8ee;
      --muted:#a9adbd;
      --blue:#1E90FF;
      --green:#36d399;
      --yellow:#fbbf24;
      --red:#ef4444;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(30,144,255,.16), transparent 55%),
                  radial-gradient(900px 700px at 90% 20%, rgba(54,211,153,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:var(--blue)}
    .wrap{max-width:1200px;margin:26px auto;padding:0 14px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 16px;border:1px solid var(--line);border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      backdrop-filter: blur(8px);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:44px;height:44px;border-radius:12px;background:rgba(30,144,255,.12);
      display:grid;place-items:center;border:1px solid rgba(30,144,255,.25);
    }
    .brand h1{font-size:16px;margin:0}
    .brand small{display:block;color:var(--muted);margin-top:2px;font-size:12px}

    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input,select,button,textarea{
      font:inherit;
      background:var(--panel2);
      color:var(--text);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
    }
    input::placeholder{color:#747a92}
    button{cursor:pointer}
    .btn{background:rgba(30,144,255,.15);border-color:rgba(30,144,255,.35)}
    .btn:hover{background:rgba(30,144,255,.22)}
    .ghost{background:transparent}
    .danger{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35)}
    .danger:hover{background:rgba(239,68,68,.18)}
    .ok{background:rgba(54,211,153,.10);border-color:rgba(54,211,153,.35)}
    .ok:hover{background:rgba(54,211,153,.16)}
    .chip{
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);color:var(--muted);font-size:12px
    }
    .grid{display:grid;grid-template-columns: 1.05fr .95fr;gap:14px;margin-top:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--line);border-radius:var(--radius);background:rgba(255,255,255,.03);
      padding:14px;
    }
    .card h2{margin:0 0 10px 0;font-size:14px;color:#d7dbef}
    .muted{color:var(--muted)}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width: 720px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    .kpi{
      border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.18);
      padding:12px 12px;
    }
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .val{font-size:22px;font-weight:600;margin-top:2px}
    .kpi .hint{font-size:12px;margin-top:4px;color:var(--muted)}
    .kpi.blue .val{color:var(--blue)}
    .kpi.green .val{color:var(--green)}
    .kpi.yellow .val{color:var(--yellow)}
    .kpi.red .val{color:var(--red)}

    .formgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 720px){ .formgrid{grid-template-columns:1fr} }
    .formgrid .full{grid-column:1 / -1}
    .field label{display:block;font-size:12px;color:var(--muted);margin:2px 0 6px}
    .field input,.field select,.field textarea{width:100%}
    textarea{min-height:70px;resize:vertical}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}

    .tablewrap{overflow:auto;border:1px solid var(--line);border-radius:14px}
    table{width:100%;border-collapse:collapse;min-width:980px}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:top}
    th{position:sticky;top:0;background:#10131b;font-size:12px;color:var(--muted);text-align:left}
    td{font-size:13px}
    .nowrap{white-space:nowrap}
    .tag{
      font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);
      display:inline-block;background:rgba(255,255,255,.03);color:var(--muted)
    }
    .tag.ok{color:var(--green);border-color:rgba(54,211,153,.35)}
    .tag.no{color:var(--red);border-color:rgba(239,68,68,.35)}
    .tag.wait{color:var(--yellow);border-color:rgba(251,191,36,.35)}
    .small{font-size:12px;color:var(--muted)}
    .hidden{display:none !important}
    .toast{
      position:fixed;right:14px;bottom:14px;
      background:#11131a;border:1px solid var(--line);border-radius:14px;
      padding:10px 12px;min-width:260px;max-width:420px;
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
    }
    .toast.err{border-color:rgba(239,68,68,.35)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,monospace}
    .sep{height:1px;background:rgba(255,255,255,.06);margin:10px 0}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">üß¨</div>
        <div>
          <h1>IEP Recrutamento ‚Äî Online</h1>
          <small>Firestore + Auth (Email/Senha) ‚Ä¢ Admin/Assistente ‚Ä¢ Realtime</small>
        </div>
      </div>

      <div class="row">
        <span id="roleChip" class="chip">N√£o autenticado</span>
        <input id="emailLogin" type="email" placeholder="email" autocomplete="username" style="width:220px">
        <input id="passwordLogin" type="password" placeholder="senha" autocomplete="current-password" style="width:180px">
        <button id="loginBtn" class="btn">Entrar</button>
        <button id="logoutBtn" class="ghost hidden">Sair</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h2>Cadastro / Edi√ß√£o</h2>

        <div class="formgrid">
          <div class="field full">
            <label>Nome / Identificador</label>
            <input id="nome" placeholder="Ex: Iniciais + c√≥digo / nome" />
          </div>

          <div class="field">
            <label>Status</label>
            <select id="status">
              <option value="">Selecione</option>
              <option>Triagem</option>
              <option>Pr√©-screening</option>
              <option>Screening</option>
              <option>Randomizado</option>
              <option>Falha de screening</option>
              <option>Em follow-up</option>
            </select>
          </div>

          <div class="field">
            <label>Estudo</label>
            <input id="estudo" placeholder="Ex: EVOKE-04 / SYMPHONY-1" />
          </div>

          <div class="field">
            <label>Data (refer√™ncia)</label>
            <input id="data" type="date" />
          </div>

          <div class="field">
            <label>Encaminhador</label>
            <select id="encaminhador">
              <option value="">Selecione</option>
              <option>Dr. Milton</option>
              <option>Dr. H√©lio</option>
              <option>Dr. Thiago</option>
              <option>ALTY</option>
              <option>Outro</option>
            </select>
          </div>

          <div class="field full hidden" id="wrapOutroEnc">
            <label>Outro encaminhador</label>
            <input id="outroEncaminhador" placeholder="Digite o encaminhador" />
          </div>

          <div class="field">
            <label>TCLE agendado?</label>
            <select id="tcleAgendado">
              <option>N√£o</option>
              <option>Sim</option>
            </select>
          </div>

          <div class="field">
            <label>TCLE assinado?</label>
            <select id="tcleAssinado">
              <option>N√£o</option>
              <option>Sim</option>
            </select>
          </div>

          <div class="field">
            <label>Eleg√≠vel?</label>
            <select id="elegivel">
              <option>Sim</option>
              <option>N√£o</option>
            </select>
          </div>

          <div class="field">
            <label>Motivo n√£o eleg√≠vel</label>
            <select id="motivoNaoElegivel">
              <option value="">(se aplic√°vel)</option>
              <option>Progress√£o</option>
              <option>Perda de follow-up</option>
              <option>Recusa do paciente</option>
              <option>Outro</option>
            </select>
          </div>

          <div class="field full hidden" id="wrapOutroMotivo">
            <label>Outro motivo</label>
            <input id="outroMotivo" placeholder="Digite o motivo" />
          </div>

          <div class="field full">
            <label>Observa√ß√µes</label>
            <textarea id="obs" placeholder="Notas r√°pidas (sem dados sens√≠veis desnecess√°rios)"></textarea>
          </div>
        </div>

        <div class="actions">
          <button id="saveBtn" class="ok">Salvar</button>
          <button id="cancelBtn" class="ghost hidden">Cancelar edi√ß√£o</button>
          <span class="small" id="accessHint">Fa√ßa login para salvar.</span>
        </div>

        <div class="sep"></div>

        <!-- ADMIN PANEL -->
        <div id="adminPanel" class="hidden">
          <h2>Painel Admin</h2>
          <div class="small muted">Crie/ative usu√°rios e defina perfil. (Requer role=admin)</div>

          <div class="formgrid" style="margin-top:10px">
            <div class="field">
              <label>E-mail do usu√°rio</label>
              <input id="adminUserEmail" placeholder="ex: assistente@..." />
            </div>
            <div class="field">
              <label>Senha tempor√°ria</label>
              <input id="adminUserPass" placeholder="m√≠n. 6 chars" />
            </div>
            <div class="field">
              <label>Role</label>
              <select id="adminUserRole">
                <option value="assistant">assistant</option>
                <option value="admin">admin</option>
              </select>
            </div>
            <div class="field">
              <label>Ativo</label>
              <select id="adminUserActive">
                <option value="true">true</option>
                <option value="false">false</option>
              </select>
            </div>
            <div class="field full">
              <button id="adminCreateBtn" class="btn">Criar usu√°rio + definir role</button>
              <div class="small muted" style="margin-top:6px">
                Obs: isso usa uma Function (mais seguro). Se voc√™ n√£o quiser Functions, eu te passo o fluxo manual pelo console.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <h2>Vis√£o geral</h2>

        <div class="kpis">
          <div class="kpi blue">
            <div class="label">Total</div>
            <div id="kpiTotal" class="val">0</div>
            <div class="hint">na vis√£o atual</div>
          </div>
          <div class="kpi green">
            <div class="label">Eleg√≠veis</div>
            <div id="kpiElig" class="val">0</div>
            <div class="hint">eleg√≠vel=Sim</div>
          </div>
          <div class="kpi red">
            <div class="label">N√£o eleg√≠veis</div>
            <div id="kpiNaoElig" class="val">0</div>
            <div class="hint">eleg√≠vel=N√£o</div>
          </div>
          <div class="kpi yellow">
            <div class="label">TCLE assinado</div>
            <div id="kpiTCLE" class="val">0</div>
            <div class="hint">tcleAssinado=Sim</div>
          </div>
        </div>

        <div style="margin-top:12px" class="formgrid">
          <div class="field">
            <label>Busca</label>
            <input id="search" placeholder="nome / status / estudo / encaminhador" />
          </div>
          <div class="field">
            <label>M√™s</label>
            <input id="monthFilter" type="month" />
          </div>
          <div class="field">
            <label>Status</label>
            <select id="statusFilter">
              <option value="">Todos</option>
              <option>Triagem</option>
              <option>Pr√©-screening</option>
              <option>Screening</option>
              <option>Randomizado</option>
              <option>Falha de screening</option>
              <option>Em follow-up</option>
            </select>
          </div>
          <div class="field">
            <label>A√ß√µes</label>
            <div class="row">
              <button id="clearMonthBtn" class="ghost">Limpar m√™s</button>
              <button id="exportBtn" class="ghost">Exportar CSV</button>
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <h2>Status (gr√°fico)</h2>
        <canvas id="statusChart" height="150"></canvas>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <h2>Pacientes</h2>
      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th>Nome</th>
              <th>Status</th>
              <th>Estudo</th>
              <th>Encaminhador</th>
              <th>Eleg√≠vel</th>
              <th>Motivo</th>
              <th>Data</th>
              <th>TCLE</th>
              <th class="nowrap">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div id="emptyMsg" class="small muted" style="margin-top:10px"></div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, doc, setDoc, deleteDoc, getDoc,
    onSnapshot, query, orderBy, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged,
    createUserWithEmailAndPassword
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // ======= firebaseConfig (SEU) =======
  const firebaseConfig = {
    apiKey: "AIzaSyCvoVAWsVMYfAQv-pISsn7mNfdInIjLDFo",
    authDomain: "iep-recrutamento.firebaseapp.com",
    projectId: "iep-recrutamento",
    storageBucket: "iep-recrutamento.firebasestorage.app",
    messagingSenderId: "297731374831",
    appId: "1:297731374831:web:684eed6683602d6c3fe51a",
    measurementId: "G-8ST5S7FWE0"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // ======= Estado =======
  let DB = [];
  let CHART = null;
  let editId = null;

  let CURRENT_USER = null;
  let CURRENT_ROLE = null;   // "admin" | "assistant"
  let IS_ACTIVE = false;

  // ======= Helpers =======
  const $ = (id) => document.getElementById(id);
  const esc = (s) => (s ?? "").toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  const uid = () => "p_" + Date.now().toString(36) + Math.random().toString(36).slice(2,8);

  function toast(msg, err=false){
    const t = $("toast");
    t.textContent = msg;
    t.classList.remove("hidden");
    t.classList.toggle("err", !!err);
    setTimeout(()=>t.classList.add("hidden"), 2400);
  }

  function parseMonth(v){
    if(!v) return null;
    const [y,m] = v.split("-").map(Number);
    return {y,m};
  }
  function inMonth(dateStr, sel){
    if(!sel) return true;
    if(!dateStr) return false;
    const d = new Date(dateStr);
    return d.getFullYear()===sel.y && (d.getMonth()+1)===sel.m;
  }

  // ======= UI toggles =======
  function toggleOutroEnc(){
    const v = $("encaminhador").value;
    $("wrapOutroEnc").classList.toggle("hidden", v !== "Outro");
    if(v !== "Outro") $("outroEncaminhador").value = "";
  }
  function toggleOutroMotivo(){
    const v = $("motivoNaoElegivel").value;
    $("wrapOutroMotivo").classList.toggle("hidden", v !== "Outro");
    if(v !== "Outro") $("outroMotivo").value = "";
  }
  $("encaminhador").addEventListener("change", toggleOutroEnc);
  $("motivoNaoElegivel").addEventListener("change", toggleOutroMotivo);
  $("elegivel").addEventListener("change", () => {
    const isNo = $("elegivel").value === "N√£o";
    $("motivoNaoElegivel").disabled = !isNo;
    $("outroMotivo").disabled = !isNo;
    if(!isNo){
      $("motivoNaoElegivel").value = "";
      $("outroMotivo").value = "";
      toggleOutroMotivo();
    }
  });

  // ======= Auth =======
  async function login(){
    const email = $("emailLogin").value.trim();
    const pass = $("passwordLogin").value;
    if(!email || !pass) return toast("Informe email e senha", true);

    try{
      await signInWithEmailAndPassword(auth, email, pass);
    }catch(e){
      toast("Erro no login: " + (e?.message || e), true);
    }
  }
  async function logout(){
    await signOut(auth);
  }
  $("loginBtn").addEventListener("click", login);
  $("logoutBtn").addEventListener("click", logout);

  function setAuthUI(logged){
    $("logoutBtn").classList.toggle("hidden", !logged);
    $("loginBtn").classList.toggle("hidden", logged);
    $("emailLogin").disabled = logged;
    $("passwordLogin").disabled = logged;
  }

  async function getRole(uid){
    const snap = await getDoc(doc(db,"users",uid));
    if(!snap.exists()) return {active:false, role:null};
    const data = snap.data() || {};
    return { active: !!data.active, role: data.role || null };
  }

  // ======= Firestore realtime =======
  function startRealtime(){
    const q = query(collection(db, "patients"), orderBy("data","desc"));
    return onSnapshot(q, (snap)=>{
      DB = snap.docs.map(d => d.data());
      refreshUI();
    }, (err)=>{
      console.error(err);
      toast("Erro ao sincronizar Firestore", true);
    });
  }
  let unsubscribe = null;

  onAuthStateChanged(auth, async (user)=>{
    CURRENT_USER = user || null;

    if(unsubscribe){ unsubscribe(); unsubscribe = null; }

    if(!user){
      setAuthUI(false);
      CURRENT_ROLE = null; IS_ACTIVE = false;
      $("roleChip").textContent = "N√£o autenticado";
      $("accessHint").textContent = "Fa√ßa login para salvar.";
      $("adminPanel").classList.add("hidden");
      DB = [];
      refreshUI();
      return;
    }

    setAuthUI(true);

    const info = await getRole(user.uid);
    CURRENT_ROLE = info.role;
    IS_ACTIVE = info.active;

    if(!IS_ACTIVE){
      $("roleChip").textContent = "Aguardando libera√ß√£o";
      $("accessHint").textContent = "Seu acesso n√£o est√° ativo (admin precisa liberar).";
      $("adminPanel").classList.add("hidden");
      DB = [];
      refreshUI();
      toast("Acesso n√£o liberado ainda.", true);
      return;
    }

    $("roleChip").textContent = `${user.email} ‚Ä¢ ${CURRENT_ROLE || "sem role"}`;
    $("accessHint").textContent = (CURRENT_ROLE === "admin")
      ? "Admin: pode criar/editar/excluir"
      : "Assistente: pode criar/editar (n√£o exclui)";

    $("adminPanel").classList.toggle("hidden", CURRENT_ROLE !== "admin");

    unsubscribe = startRealtime();
    toast("Conectado (online)!");
  });

  // ======= Form =======
  function validate(){
    const req = ["nome","status","estudo","data"];
    for(const id of req){
      if(!$(id).value.trim()){
        toast("Preencha Nome, Status, Estudo e Data", true);
        return false;
      }
    }
    return true;
  }

  function buildRec(){
    const enc = ($("encaminhador").value === "Outro")
      ? ($("outroEncaminhador").value.trim() || "Outro")
      : $("encaminhador").value;

    const isNo = $("elegivel").value === "N√£o";
    const motivo = isNo
      ? (($("motivoNaoElegivel").value === "Outro")
          ? ($("outroMotivo").value.trim() || "Outro")
          : $("motivoNaoElegivel").value)
      : "";

    return {
      id: editId || uid(),
      nome: $("nome").value.trim(),
      status: $("status").value.trim(),
      estudo: $("estudo").value.trim(),
      data: $("data").value,
      encaminhador: enc || "",
      tcleAgendado: $("tcleAgendado").value,
      tcleAssinado: $("tcleAssinado").value,
      elegivel: $("elegivel").value,
      motivoNaoElegivel: motivo || "",
      obs: $("obs").value.trim()
    };
  }

  async function save(){
    if(!CURRENT_USER || !IS_ACTIVE) return toast("Sem acesso. Fa√ßa login.", true);
    if(!validate()) return;

    const rec = buildRec();
    try{
      await setDoc(doc(db,"patients",rec.id), {
        ...rec,
        updatedAt: serverTimestamp(),
        updatedBy: CURRENT_USER.uid
      }, {merge:true});

      resetForm();
      toast("Salvo!");
    }catch(e){
      console.error(e);
      toast("Falha ao salvar: " + (e?.message||e), true);
    }
  }

  function resetForm(){
    editId = null;
    $("nome").value = "";
    $("status").value = "";
    $("estudo").value = "";
    $("data").value = "";
    $("encaminhador").value = "";
    $("outroEncaminhador").value = "";
    $("tcleAgendado").value = "N√£o";
    $("tcleAssinado").value = "N√£o";
    $("elegivel").value = "Sim";
    $("motivoNaoElegivel").value = "";
    $("outroMotivo").value = "";
    $("obs").value = "";
    toggleOutroEnc();
    toggleOutroMotivo();
    $("cancelBtn").classList.add("hidden");
  }

  function fillForm(p){
    editId = p.id;
    $("nome").value = p.nome || "";
    $("status").value = p.status || "";
    $("estudo").value = p.estudo || "";
    $("data").value = p.data || "";
    $("tcleAgendado").value = p.tcleAgendado || "N√£o";
    $("tcleAssinado").value = p.tcleAssinado || "N√£o";
    $("elegivel").value = p.elegivel || "Sim";
    $("obs").value = p.obs || "";

    const knownEnc = ["Dr. Milton","Dr. H√©lio","Dr. Thiago","ALTY"];
    if(p.encaminhador && knownEnc.includes(p.encaminhador)){
      $("encaminhador").value = p.encaminhador;
      $("outroEncaminhador").value = "";
    } else if(p.encaminhador){
      $("encaminhador").value = "Outro";
      $("outroEncaminhador").value = p.encaminhador;
    } else {
      $("encaminhador").value = "";
      $("outroEncaminhador").value = "";
    }
    toggleOutroEnc();

    const isNo = (p.elegivel === "N√£o");
    $("motivoNaoElegivel").disabled = !isNo;
    $("outroMotivo").disabled = !isNo;

    const knownMot = ["Progress√£o","Perda de follow-up","Recusa do paciente","Outro"];
    if(isNo){
      if(p.motivoNaoElegivel && knownMot.includes(p.motivoNaoElegivel)){
        $("motivoNaoElegivel").value = p.motivoNaoElegivel;
        $("outroMotivo").value = "";
      } else if(p.motivoNaoElegivel){
        $("motivoNaoElegivel").value = "Outro";
        $("outroMotivo").value = p.motivoNaoElegivel;
      } else {
        $("motivoNaoElegivel").value = "";
        $("outroMotivo").value = "";
      }
    } else {
      $("motivoNaoElegivel").value = "";
      $("outroMotivo").value = "";
    }
    toggleOutroMotivo();

    $("cancelBtn").classList.remove("hidden");
  }

  async function remove(id){
    if(!CURRENT_USER || !IS_ACTIVE) return toast("Sem acesso.", true);
    if(CURRENT_ROLE !== "admin") return toast("Assistente n√£o pode excluir.", true);
    if(!confirm("Excluir este registro?")) return;

    try{
      await deleteDoc(doc(db,"patients",id));
      toast("Exclu√≠do.");
    }catch(e){
      toast("Falha ao excluir: " + (e?.message||e), true);
    }
  }

  $("saveBtn").addEventListener("click", save);
  $("cancelBtn").addEventListener("click", () => { resetForm(); toast("Edi√ß√£o cancelada"); });

  // ======= Dataset / filtros =======
  function dataset(){
    const q = ($("search").value || "").toLowerCase();
    const selMonth = parseMonth($("monthFilter").value);
    const st = ($("statusFilter").value || "").toLowerCase();

    return DB
      .filter(p=>{
        const hitQ = !q
          || (p.nome||"").toLowerCase().includes(q)
          || (p.status||"").toLowerCase().includes(q)
          || (p.estudo||"").toLowerCase().includes(q)
          || (p.encaminhador||"").toLowerCase().includes(q);

        const hitM = inMonth(p.data, selMonth);
        const hitS = !st || (p.status||"").toLowerCase()===st;

        return hitQ && hitM && hitS;
      })
      .sort((a,b)=> (b.data||"").localeCompare(a.data||""));
  }

  function updateKPIs(list){
    $("kpiTotal").textContent = list.length;
    $("kpiElig").textContent = list.filter(x=>x.elegivel==="Sim").length;
    $("kpiNaoElig").textContent = list.filter(x=>x.elegivel==="N√£o").length;
    $("kpiTCLE").textContent = list.filter(x=>x.tcleAssinado==="Sim").length;
  }

  function renderTable(){
    const tbody = $("tableBody");
    const list = dataset();
    tbody.innerHTML = "";

    for(const r of list){
      const tagElig = (r.elegivel==="Sim") ? `<span class="tag ok">Sim</span>` : `<span class="tag no">N√£o</span>`;
      const tagTCLE = (r.tcleAssinado==="Sim") ? `<span class="tag ok">Sim</span>` : `<span class="tag">N√£o</span>`;

      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>
            <div>${esc(r.nome)}</div>
            ${r.obs ? `<div class="small">${esc(r.obs)}</div>` : ``}
          </td>
          <td>${esc(r.status)}</td>
          <td>${esc(r.estudo)}</td>
          <td>${esc(r.encaminhador)}</td>
          <td>${tagElig}</td>
          <td>${esc(r.motivoNaoElegivel || "-")}</td>
          <td class="nowrap">${esc(r.data)}</td>
          <td>${tagTCLE}</td>
          <td class="nowrap">
            <button class="btn" data-edit="${esc(r.id)}">‚úèÔ∏è</button>
            <button class="danger" data-del="${esc(r.id)}">üóëÔ∏è</button>
          </td>
        </tr>
      `);
    }

    $("emptyMsg").textContent = list.length ? "" : "Sem registros para esta vis√£o.";
    updateKPIs(list);
    updateChart(list);

    // bind buttons
    document.querySelectorAll("[data-edit]").forEach(b=>{
      b.onclick = () => {
        const id = b.getAttribute("data-edit");
        const p = DB.find(x=>x.id===id);
        if(p) fillForm(p);
      };
    });
    document.querySelectorAll("[data-del]").forEach(b=>{
      b.onclick = () => remove(b.getAttribute("data-del"));
    });
  }

  function updateChart(list){
    const counts = {};
    for(const p of list){
      const k = p.status || "Sem status";
      counts[k] = (counts[k]||0)+1;
    }
    const labels = Object.keys(counts);
    const data = Object.values(counts);

    const ctx = $("statusChart").getContext("2d");
    if(CHART) CHART.destroy();
    CHART = new Chart(ctx, {
      type:"pie",
      data:{ labels, datasets:[{ data }] }
    });
  }

  function refreshUI(){
    renderTable();
  }

  ["search","monthFilter","statusFilter"].forEach(id=>{
    $(id).addEventListener("input", refreshUI);
    $(id).addEventListener("change", refreshUI);
  });

  $("clearMonthBtn").addEventListener("click", ()=>{
    $("monthFilter").value = "";
    refreshUI();
  });

  // ======= CSV Export =======
  $("exportBtn").addEventListener("click", ()=>{
    const rows = dataset();
    const header = ["id","nome","status","estudo","data","encaminhador","tcleAgendado","tcleAssinado","elegivel","motivoNaoElegivel","obs","updatedBy"];
    const csv = [
      header.join(","),
      ...rows.map(r => header.map(h => `"${String(r[h] ?? "").replaceAll('"','""')}"`).join(","))
    ].join("\n");

    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "iep_recrutamento_export.csv";
    a.click();
    URL.revokeObjectURL(url);
  });

  // ======= Admin Panel (opcional) =======
  // IMPORTANTE: criar usu√°rio pelo front-end exige uma abordagem segura.
  // Aqui eu deixei o UI pronto, mas a cria√ß√£o REAL (recomendada) deve ser via Cloud Function/Admin SDK.
  // Para n√£o travar seu fluxo, abaixo deixo o m√©todo manual oficial (console) e voc√™ pode ignorar esse bot√£o.
  $("adminCreateBtn").addEventListener("click", async ()=>{
    toast("Para cria√ß√£o segura de usu√°rios, use o console (Authentication). Posso te passar a Cloud Function se voc√™ quiser.", true);
  });

  // ======= Init =======
  // Ajustes iniciais do formul√°rio
  toggleOutroEnc();
  toggleOutroMotivo();
  $("motivoNaoElegivel").disabled = true;
  $("outroMotivo").disabled = true;

  // Primeira render (sem dados)
  refreshUI();
</script>

</body>
</html>
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IEP Recrutamento — Online</title>
  <style>
    body { font-family: system-ui, Arial; margin: 0; padding: 18px; background:#0b1220; color:#e6eefc; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .card { background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:14px; }
    .w50 { flex:1; min-width:320px; }
    input, select, button { padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.2); background:rgba(0,0,0,.25); color:#fff; }
    button { cursor:pointer; }
    button.primary { background:#2a67ff; border-color:#2a67ff; }
    button.link { background:transparent; border:none; text-decoration:underline; opacity:.9; }
    .muted { opacity:.75; font-size: 13px; }
    .tabs button { margin-right: 8px; }
    .hidden { display:none; }
    .grid { display:grid; grid-template-columns: repeat(7, minmax(42px,1fr)); gap:8px; }
    .day { aspect-ratio: 1/1; border-radius:12px; border:1px solid rgba(255,255,255,.14); display:flex; align-items:flex-start; justify-content:flex-start; padding:10px; cursor:pointer; background: rgba(0,0,0,.18); }
    .day:hover { outline: 2px solid rgba(42,103,255,.4); }
    .day.selected { outline: 2px solid #2a67ff; }
    .toast { position: fixed; right: 14px; top: 14px; z-index: 99; padding: 12px 14px; border-radius: 12px; max-width: 420px; }
    .toast.ok { background: rgba(34,197,94,.18); border:1px solid rgba(34,197,94,.4); }
    .toast.err{ background: rgba(239,68,68,.18); border:1px solid rgba(239,68,68,.4); }
    .topbar { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .pill { padding: 8px 10px; border-radius: 999px; border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.18); }
  </style>
</head>

<body>
  <div id="toast" class="toast hidden"></div>

  <div class="topbar card">
    <div>
      <div style="font-size:18px;font-weight:700;">IEP Recrutamento — Online</div>
      <div class="muted">Firestore + Auth (Email/Senha) • Admin/Assistente • Realtime</div>
    </div>

    <div class="row" style="align-items:center;">
      <div id="authPill" class="pill">Não autenticado</div>
      <button id="btnLogout" class="hidden">Sair</button>
    </div>
  </div>

  <div class="row" style="margin-top:14px;">
    <!-- LOGIN -->
    <div class="card w50" id="loginCard">
      <div style="font-weight:700;margin-bottom:10px;">Login</div>
      <div class="row">
        <input id="email" type="email" placeholder="seu@email.com" style="flex:1; min-width:260px;" />
        <input id="password" type="password" placeholder="********" style="flex:1; min-width:200px;" />
        <button id="btnLogin" class="primary">Entrar</button>
      </div>
      <div style="margin-top:10px;">
        <button id="btnForgot" class="link" type="button">Esqueci minha senha</button>
        <div class="muted" style="margin-top:6px;">
          Dica: se der “muitas tentativas”, use “Esqueci minha senha” para destravar.
        </div>
      </div>
    </div>

    <!-- ABAS -->
    <div class="card w50">
      <div class="tabs" style="margin-bottom:10px;">
        <button id="tabRecruit" class="primary">Recrutamento</button>
        <button id="tabScreening">Screening</button>
      </div>

      <!-- RECRUTAMENTO (placeholder apenas para manter seu layout) -->
      <div id="recruitView">
        <div style="font-weight:700;">Recrutamento</div>
        <div class="muted">Aqui você mantém sua tela atual (cadastro, indicadores, etc.).</div>
      </div>

      <!-- SCREENING -->
      <div id="screeningView" class="hidden">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
          <div style="font-weight:700;">Screening — Calendário</div>
          <div class="row">
            <button id="btnPrevMonth">◀ Mês</button>
            <div id="monthLabel" class="pill">—</div>
            <button id="btnNextMonth">Mês ▶</button>
          </div>
        </div>

        <div class="muted" style="margin:10px 0;">
          Clique em um dia para selecionar e depois salve o procedimento. (Funciona somente logado)
        </div>

        <div class="grid" id="screeningCalendar"></div>

        <div class="card" style="margin-top:12px;">
          <div style="font-weight:700;">Novo procedimento</div>
          <div class="muted" id="selectedDayLabel" style="margin:6px 0 10px;">Dia selecionado: —</div>

          <form id="procForm" class="row" style="align-items:center;">
            <input id="procPatient" placeholder="ID / Nome do paciente" style="flex:1; min-width:220px;" />
            <select id="procType" style="min-width:200px;">
              <option value="">Tipo</option>
              <option>TCLE agendado</option>
              <option>TCLE assinado</option>
              <option>Exames laboratoriais</option>
              <option>Exames de imagem</option>
              <option>Consulta / Avaliação</option>
              <option>Falha de screening</option>
              <option>Randomizado</option>
              <option>Outro</option>
            </select>
            <input id="procTime" placeholder="Hora (opcional) ex: 14:30" style="min-width:180px;" />
            <button id="btnSaveProcedure" class="primary" type="submit">Salvar procedimento</button>
          </form>

          <div class="muted" style="margin-top:10px;">
            Se algo bloquear o salvamento, vai aparecer um erro detalhado no toast e no Console.
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    // =========================
    // 1) Firebase imports
    // =========================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

    import {
      getAuth,
      setPersistence,
      browserLocalPersistence,
      browserSessionPersistence,
      inMemoryPersistence,
      signInWithEmailAndPassword,
      sendPasswordResetEmail,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // =========================
    // 2) COLE AQUI seu firebaseConfig
    // =========================
    const firebaseConfig = {
      apiKey: "COLE_AQUI",
      authDomain: "COLE_AQUI",
      projectId: "COLE_AQUI",
      storageBucket: "COLE_AQUI",
      messagingSenderId: "COLE_AQUI",
      appId: "COLE_AQUI"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // =========================
    // 3) Toast
    // =========================
    function toast(msg, type="ok") {
      const el = document.getElementById("toast");
      el.className = "toast " + type;
      el.textContent = msg;
      el.classList.remove("hidden");
      setTimeout(() => el.classList.add("hidden"), 5200);
    }

    // =========================
    // 4) Auth persistence fallback (evita bugs em navegadores)
    // =========================
    (async () => {
      try {
        await setPersistence(auth, browserLocalPersistence);
        console.log("[AUTH] Persistence: local");
      } catch (e1) {
        try {
          await setPersistence(auth, browserSessionPersistence);
          console.log("[AUTH] Persistence: session");
        } catch (e2) {
          await setPersistence(auth, inMemoryPersistence);
          console.log("[AUTH] Persistence: memory (storage bloqueado)");
        }
      }
    })();

    // =========================
    // 5) Login + Forgot + Logout
    // =========================
    const emailEl = document.getElementById("email");
    const passEl  = document.getElementById("password");
    const btnLogin = document.getElementById("btnLogin");
    const btnForgot = document.getElementById("btnForgot");
    const btnLogout = document.getElementById("btnLogout");
    const authPill = document.getElementById("authPill");

    btnLogin.onclick = async () => {
      const email = (emailEl.value || "").trim();
      const pass  = passEl.value || "";
      if (!email || !pass) return toast("Preencha e-mail e senha.", "err");

      btnLogin.disabled = true;

      try {
        await signInWithEmailAndPassword(auth, email, pass);
        toast("Login realizado!", "ok");
      } catch (err) {
        console.error("ERRO LOGIN:", err);

        const msg = ({
          "auth/too-many-requests": "Muitas tentativas. Aguarde alguns minutos ou clique em “Esqueci minha senha”.",
          "auth/wrong-password": "Senha incorreta. Tente novamente ou clique em “Esqueci minha senha”.",
          "auth/user-not-found": "Usuário não encontrado. Verifique o e-mail digitado.",
          "auth/invalid-email": "E-mail inválido.",
          "auth/invalid-credential": "Credencial inválida. Verifique e-mail/senha."
        })[err.code] || ("Erro no login: " + (err.code || err.message));

        toast(msg, "err");
      } finally {
        btnLogin.disabled = false;
      }
    };

    btnForgot.onclick = async () => {
      const email = (emailEl.value || "").trim();
      if (!email) return toast("Digite seu e-mail para enviar o link de redefinição.", "err");

      try {
        await sendPasswordResetEmail(auth, email);
        toast("Enviei um link de redefinição de senha para seu e-mail.", "ok");
      } catch (err) {
        console.error("RESET SENHA:", err);
        toast("Erro ao enviar redefinição: " + (err.code || err.message), "err");
      }
    };

    btnLogout.onclick = async () => {
      try {
        await signOut(auth);
        toast("Você saiu.", "ok");
      } catch (err) {
        console.error(err);
        toast("Erro ao sair: " + (err.code || err.message), "err");
      }
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        authPill.textContent = user.email || "Autenticado";
        btnLogout.classList.remove("hidden");
      } else {
        authPill.textContent = "Não autenticado";
        btnLogout.classList.add("hidden");
      }
    });

    // =========================
    // 6) Tabs
    // =========================
    const tabRecruit = document.getElementById("tabRecruit");
    const tabScreening = document.getElementById("tabScreening");
    const recruitView = document.getElementById("recruitView");
    const screeningView = document.getElementById("screeningView");

    tabRecruit.onclick = () => {
      tabRecruit.classList.add("primary");
      tabRecruit.classList.remove("link");
      tabScreening.classList.remove("primary");

      recruitView.classList.remove("hidden");
      screeningView.classList.add("hidden");
    };

    tabScreening.onclick = () => {
      tabScreening.classList.add("primary");
      tabRecruit.classList.remove("primary");

      recruitView.classList.add("hidden");
      screeningView.classList.remove("hidden");
      renderCalendar();
    };

    // =========================
    // 7) Screening Calendar + Save
    // =========================
    const cal = document.getElementById("screeningCalendar");
    const monthLabel = document.getElementById("monthLabel");
    const selectedDayLabel = document.getElementById("selectedDayLabel");
    const btnPrevMonth = document.getElementById("btnPrevMonth");
    const btnNextMonth = document.getElementById("btnNextMonth");

    const procForm = document.getElementById("procForm");
    const procPatient = document.getElementById("procPatient");
    const procType = document.getElementById("procType");
    const procTime = document.getElementById("procTime");
    const btnSaveProcedure = document.getElementById("btnSaveProcedure");

    // impede reload no submit
    procForm.addEventListener("submit", (e) => e.preventDefault());

    let viewDate = new Date(); // mês atual
    let selectedDateISO = null;

    btnPrevMonth.onclick = () => { viewDate.setMonth(viewDate.getMonth() - 1); renderCalendar(); };
    btnNextMonth.onclick = () => { viewDate.setMonth(viewDate.getMonth() + 1); renderCalendar(); };

    function pad2(n){ return String(n).padStart(2,"0"); }

    function renderCalendar() {
      const y = viewDate.getFullYear();
      const m = viewDate.getMonth(); // 0-11
      const first = new Date(y, m, 1);
      const last = new Date(y, m + 1, 0);
      const monthName = first.toLocaleDateString("pt-BR", { month:"long", year:"numeric" });

      monthLabel.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);

      cal.innerHTML = "";

      // cria dias do mês
      for (let d = 1; d <= last.getDate(); d++) {
        const iso = `${y}-${pad2(m+1)}-${pad2(d)}`;
        const cell = document.createElement("div");
        cell.className = "day";
        cell.dataset.date = iso;
        cell.textContent = d;

        if (iso === selectedDateISO) cell.classList.add("selected");
        cal.appendChild(cell);
      }
    }

    // clique no dia (robusto com closest)
    cal.addEventListener("click", (e) => {
      const cell = e.target.closest("[data-date]");
      if (!cell) return;

      selectedDateISO = cell.dataset.date;

      cal.querySelectorAll(".day.selected").forEach(x => x.classList.remove("selected"));
      cell.classList.add("selected");

      const [yy, mm, dd] = selectedDateISO.split("-");
      selectedDayLabel.textContent = `Dia selecionado: ${dd}/${mm}/${yy}`;
    });

    // salvar procedimento
    btnSaveProcedure.addEventListener("click", async (e) => {
      e.preventDefault();

      if (!selectedDateISO) return toast("Selecione um dia no calendário.", "err");
      if (!auth.currentUser) return toast("Faça login para salvar.", "err");

      const patientId = (procPatient.value || "").trim();
      const tipo = (procType.value || "").trim();
      const hora = (procTime.value || "").trim();

      if (!patientId || !tipo) return toast("Preencha paciente e tipo.", "err");

      try {
        const [Y, M, D] = selectedDateISO.split("-").map(Number);
        const dateObj = new Date(Y, M - 1, D, 12, 0, 0);

        await addDoc(collection(db, "screening_procedures"), {
          dateISO: selectedDateISO,
          dateTS: Timestamp.fromDate(dateObj),
          patientId,
          tipo,
          hora,
          createdAt: serverTimestamp(),
          createdBy: auth.currentUser.uid
        });

        toast("Procedimento salvo no Screening!", "ok");
        procTime.value = "";
      } catch (err) {
        console.error("ERRO SCREENING SAVE:", err);
        toast("Erro ao salvar Screening: " + (err.code || err.message), "err");
      }
    });

    // inicia calendário se abrir na aba screening
    // renderCalendar();

  </script>
</body>
</html>
